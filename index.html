<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PracticeTrack - Music Practice Companion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- SheetJS Excel Export Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <base href="/PracticeTrack/">
  <style>
    :root {
      --primary-color: #4154b3;
      --primary-light: #7681e4;
      --primary-dark: #2a3990;
      --secondary-color: #FF6A4B;
      --secondary-light: #ffb4a1;
      --secondary-dark: #E25B3D;
      --text-color: #333;
      --text-light: #666;
      --bg-color: #f5f5f5;
      --card-color: #fff;
      --border-color: #e0e0e0;
      --success-color: #4caf50;
      --success-light: #e8f5e9;
      --warning-color: #ff9800;
      --warning-light: #fff3e0;
      --error-color: #f44336;
      --error-light: #ffebee;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
      --radius-sm: 5px;
      --radius: 10px;
      --radius-lg: 15px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    .container {
      background-color: var(--card-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 20px;
      text-align: center;
    }

    .logo-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      overflow: hidden;
      border-radius: var(--radius);
      padding: 20px;
      background-color: white;
      box-shadow: var(--shadow-sm);
    }

    .logo-text {
      font-size: 32px;
      font-weight: bold;
      letter-spacing: 1px;
      text-align: center;
    }
    
    .practice {
      color: var(--primary-color);
    }
    
    .track {
      color: var(--secondary-color);
    }
    
    .tagline {
      color: #555555;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
    }
    
    .line {
      height: 2px;
      width: 180px;
      background: linear-gradient(to right, var(--primary-color), var(--primary-light));
      margin: 0 10px;
    }
    
    .music-note {
      color: var(--primary-color);
      font-size: 18px;
    }
    
    .music-note-orange {
      color: var(--secondary-color);
      font-size: 18px;
    }

    .menu {
      display: flex;
      justify-content: space-around;
      list-style-type: none;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding: 0;
      gap: 10px;
    }

    .menu-item {
      padding: 12px 15px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      position: relative;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .menu-item:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background-color: var(--primary-color);
      transition: var(--transition);
    }

    .menu-item:hover:after {
      width: 25%;
    }

    .menu-item.active {
      color: var(--primary-color);
    }

    .menu-item.active:after {
      width: 80%;
    }

    .tab {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab.active {
      display: block;
    }

    .card {
      background-color: var(--card-color);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      text-align: center;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .timer-card {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .timer-card:before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0.1) 10px,
        rgba(255, 255, 255, 0.05) 10px,
        rgba(255, 255, 255, 0.05) 20px
      );
      z-index: 0;
      opacity: 0.3;
    }

    .timer-content {
      position: relative;
      z-index: 1;
    }

    .timer-display {
      font-size: 4rem;
      text-align: center;
      margin: 15px 0;
      font-weight: bold;
      color: white;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: var(--transition);
      position: relative;
    }

    .timer-display:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 3px;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: 3px;
    }

    .timer-progress {
      height: 6px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin: 15px 0;
      overflow: hidden;
    }

    .timer-progress-bar {
      height: 100%;
      background-color: white;
      border-radius: 3px;
      width: 0%;
      transition: width 1s linear;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: var(--gray-200);
      color: var(--text-color);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .start { 
      background-color: var(--success-color); 
      color: white;
    }
    
    .start:hover { 
      background-color: #43a047; 
    }
    
    .pause { 
      background-color: var(--warning-color); 
      color: white;
    }
    
    .pause:hover { 
      background-color: #fb8c00; 
    }
    
    .stop { 
      background-color: var(--error-color); 
      color: white;
    }
    
    .stop:hover { 
      background-color: #e53935; 
    }
    
    .resume { 
      background-color: var(--primary-color); 
      color: white;
    }
    
    .resume:hover { 
      background-color: var(--primary-dark); 
    }

    button:disabled {
      background-color: var(--gray-300);
      color: var(--text-light);
      cursor: not-allowed;
      transform: none;
      opacity: 0.7;
    }

    .hidden {
      display: none !important;
    }

    .form-group {
      margin-bottom: 1rem;
      text-align: center;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
      text-align: center;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: var(--gray-100);
      transition: var(--transition);
      text-align: center;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(65, 84, 179, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .required-field:after {
      content: '*';
      color: var(--error-color);
      margin-left: 4px;
    }

    .icon-input {
      display: flex;
      justify-content: center;
      position: relative;
      width: 100%;
    }
    
    .icon-input svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      width: 20px;
      height: 20px;
    }
    
    .icon-input input,
    .icon-input select,
    .icon-input textarea {
      width: 100%;
      padding-left: 40px;
      text-align: center;
    }
    
    /* Adjust select dropdowns for better centering */
    select {
      text-align-last: center; /* Centers the selected item text */
      padding-right: 30px; /* Space for the dropdown arrow */
    }

    .save-btn {
      background-color: var(--primary-color);
      color: white;
      width: 100%;
      padding: 12px;
      font-weight: 600;
      border-radius: var(--radius-sm);
      margin-top: 10px;
      transition: var(--transition);
    }

    .save-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .save-btn:disabled {
      background-color: var(--gray-300);
      color: var(--text-light);
      transform: none;
    }

    .save-btn.active-save {
      background-color: var(--success-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .save-btn.active-save:hover {
      background-color: #43a047;
    }

    /* Metronome */
    .metronome-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding: 15px;
      background-color: var(--gray-100);
      border-radius: var(--radius);
    }
    
    .bpm-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      text-align: center;
      min-width: 80px;
    }
    
    .tempo-slider {
      flex: 1;
      margin: 0 15px;
    }
    
    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--gray-300);
      border-radius: 3px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
    }
    
    .metronome-button {
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    /* Session list styling */
    .session-list {
      list-style-type: none;
      margin-top: 15px;
    }

    .session-list li {
      background-color: var(--gray-100);
      margin-bottom: 15px;
      padding: 15px;
      border-radius: var(--radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .session-list li:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .session-info {
      flex: 1;
    }

    .session-header {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary-color);
    }

    .session-details {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .session-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      transition: var(--transition);
    }

    .delete-btn {
      background-color: var(--error-light);
      color: var(--error-color);
    }

    .delete-btn:hover {
      background-color: var(--error-color);
      color: white;
    }

    .edit-btn {
      background-color: var(--primary-light);
      color: var(--primary-dark);
    }

    .edit-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    /* Chart styling */
    .chart-container {
      height: 200px;
      margin-top: 10px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
    }

    .chart-bar {
      flex: 1;
      margin: 0 2px;
      background-color: var(--primary-light);
      border-radius: 3px 3px 0 0;
      position: relative;
      min-height: 1px;
    }

    .chart-day {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 5px;
    }

    .chart-bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* Stats cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: var(--gray-100);
      padding: 15px;
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .empty-message {
      text-align: center;
      padding: 30px;
      color: var(--text-light);
      background-color: var(--gray-100);
      border-radius: var(--radius);
      margin-top: 20px;
    }

    /* Goals list styling */
    .goals-list {
      list-style-type: none;
      margin-top: 15px;
    }

    .goals-list li {
      background-color: var(--gray-100);
      margin-bottom: 10px;
      padding: 12px 15px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .goals-list li:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .goals-list li.completed {
      text-decoration: line-through;
      color: var(--text-light);
    }

    .goal-checkbox {
      min-width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid var(--primary-color);
      position: relative;
      display: inline-block;
      cursor: pointer;
    }

    .goal-checkbox.checked:after {
      content: '';
      position: absolute;
      top: 1px;
      left: 5px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .goal-checkbox.checked {
      background-color: var(--primary-color);
    }

    .goal-text {
      flex: 1;
      word-break: break-word;
    }

    /* Notification styling */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    
    #notification.active {
      opacity: 1;
      transform: translateY(0);
    }
    
    #notification.success {
      background-color: var(--success-light);
      border-left: 4px solid var(--success-color);
      color: var(--success-color);
    }
    
    #notification.error {
      background-color: var(--error-light);
      border-left: 4px solid var(--error-color);
      color: var(--error-color);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Dark theme */
    body.dark-theme {
      --text-color: #e0e0e0;
      --text-light: #aaaaaa;
      --bg-color: #121212;
      --card-color: #1e1e1e;
      --border-color: #333;
      --gray-100: #2a2a2a;
      --gray-200: #333;
      --gray-300: #444;
    }

    /* Light theme */
    body.light-theme {
      --text-color: #333;
      --text-light: #666;
      --bg-color: #f8f9fa;
      --card-color: #fff;
      --border-color: #eee;
      --gray-100: #f4f4f4;
      --gray-200: #e0e0e0;
      --gray-300: #ccc;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      .timer-display {
        font-size: 3rem;
      }

      .controls {
        flex-wrap: wrap;
        gap: 10px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

      .menu {
        padding-bottom: 5px;
        margin: 0 -15px 20px -15px;
        padding: 0 15px;
      }

      .menu-item {
        padding: 10px;
        font-size: 0.9rem;
      }

      .menu-item svg {
        width: 14px;
        height: 14px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .filter-controls {
        flex-direction: column;
        gap: 10px;
      }

      .filter-group {
        min-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .timer-display {
        font-size: 2.5rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .menu {
        justify-content: flex-start;
      }

      .chart-container {
        height: 150px;
        margin: 10px -15px;
        padding: 0 15px;
      }

      .chart-day {
        font-size: 0.7rem;
        transform: rotate(-45deg);
        margin-top: 10px;
      }

      .stat-card {
        padding: 10px;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .stat-label {
        font-size: 0.8rem;
      }

      button {
        padding: 8px 12px;
        font-size: 0.9rem;
      }

      button svg {
        width: 16px;
        height: 16px;
      }
    }

    /* Add horizontal scroll indicator for menu */
    .menu::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 30px;
      background: linear-gradient(to right, transparent, var(--bg-color));
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .menu.scroll-right::after {
      opacity: 1;
    }

    .categories-list {
      margin-top: 10px;
      background: var(--gray-100);
      border-radius: var(--radius);
      padding: 10px;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      background: var(--card-color);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .category-item:hover {
      box-shadow: var(--shadow-sm);
    }

    .category-item:last-child {
      margin-bottom: 0;
    }

    .category-name {
      flex: 1;
    }

    .category-actions {
      display: flex;
      gap: 5px;
    }

    .category-actions button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .category-actions .delete-btn:hover {
      background-color: var(--error-light);
      color: var(--error-color);
    }

    .category-actions .toggle-btn:hover {
      background-color: var(--gray-200);
    }

    .category-item.hidden-category {
      opacity: 0.6;
      border-style: dashed;
    }

    .filter-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 200px;
    }

    .filter-group label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .filter-group select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .filter-group select:hover {
      border-color: var(--border-hover);
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-alpha);
    }

    /* Update existing styles */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }

    .form-group input[type="text"]:hover {
      border-color: var(--border-hover);
    }

    .form-group input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-alpha);
    }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--gray-300);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spinner 1s linear infinite;
    }

    .loading-message {
      color: white;
      background-color: var(--primary-color);
      padding: 1rem 2rem;
      border-radius: var(--radius);
      margin-top: 15px;
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    @keyframes spinner {
      to {transform: rotate(360deg);}
    }

    .settings-icon {
      margin-left: auto;
    }

    .settings-icon span {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      .menu {
        padding: 0 10px;
        gap: 5px;
        justify-content: space-between;
      }

      .menu-item {
        padding: 10px;
        font-size: 0.9rem;
      }

      .menu-item span {
        display: none;
      }

      .menu-item svg {
        width: 20px;
        height: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .chart-container {
        height: 150px;
        overflow-x: auto;
        padding-bottom: 20px;
      }

      .chart-bar-container {
        min-width: 40px;
      }

      .filter-controls {
        flex-direction: column;
        gap: 10px;
      }

      .filter-group {
        width: 100%;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-value {
        font-size: 1.2rem;
      }

      .stat-label {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .menu-item {
        padding: 8px;
      }

      .menu-item svg {
        width: 24px;
        height: 24px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 120px;
      }

      .chart-bar-container {
        min-width: 35px;
      }
    }

    /* Add camera functionality styles */
    .camera-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: var(--secondary-color);
      color: white;
      padding: 12px 15px;
      border-radius: var(--radius);
      margin: 15px 0;
      cursor: pointer;
      transition: var(--transition);
      font-weight: bold;
      font-size: 1.1em;
    }

    .camera-button:hover {
      background-color: var(--secondary-dark);
      transform: translateY(-2px);
    }

    .camera-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
    }

    .camera-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .camera-preview {
      flex: 1;
      width: 100%;
      object-fit: contain;
      background-color: #000;
    }

    .camera-controls {
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .camera-controls button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-controls button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .media-preview {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 1001;
      flex-direction: column;
    }

    .media-preview.show {
      display: flex;
    }

    .media-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      margin-right: 5px;
      cursor: pointer;
    }

    .session-media {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    /* Add new styles for the guide */
    .guide-content {
      max-width: 800px;
      margin: 0 auto;
    }

    .guide-section {
      margin-bottom: 30px;
    }

    .guide-section h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    .guide-section p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .feature-list {
      list-style-type: none;
      padding: 0;
    }

    .feature-list li {
      margin-bottom: 15px;
      padding-left: 25px;
      position: relative;
    }

    .feature-list li:before {
      content: '♪';
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }

    /* Hide guide tab on mobile */
    @media (max-width: 768px) {
      .menu-item[data-tab="guide"] {
        display: none;
      }
    }

    /* Add new styles for the guide button, modal, and footer */
    .guide-button {
      display: block;
      width: 100%;
      margin-top: 15px;
      padding: 12px;
      background-color: var(--primary-light);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .guide-button:hover {
      background-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background-color: var(--card-color);
      margin: 20px auto;
      padding: 20px;
      border-radius: var(--radius);
      max-width: 800px;
      position: relative;
      box-shadow: var(--shadow-lg);
    }

    .close-modal {
      position: absolute;
      right: 20px;
      top: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      border-top: 1px solid var(--border-color);
      color: var(--text-light);
    }

    .footer a {
      color: var(--primary-color);
      text-decoration: none;
      transition: var(--transition);
    }

    .footer a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .media-text-only {
      height: 150px;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
      background-color: var(--background-light);
      color: var(--text-color);
    }

    .media-saved-locally {
      font-size: 0.8rem;
      color: var(--secondary-color);
      margin-top: 8px;
    }

    /* Media preview and download styles */
    #media-preview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .download-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .download-button:hover {
      background-color: var(--primary-color-dark, #005a9c);
    }

    .download-instructions {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      max-width: 85%;
      text-align: center;
      color: white;
    }

    /* Adjustments for mobile */
    @media (max-width: 768px) {
      #photo-preview, #video-preview {
        max-width: 90%;
        max-height: 50vh;
      }
      
      .download-instructions {
        font-size: 14px;
        padding: 10px;
      }
    }

    /* Media Gallery Styles */
    .media-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .media-item {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .media-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .media-preview {
      height: 150px;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .media-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-thumbnail {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-placeholder-item {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #888;
    }

    .media-type-icon {
      margin-bottom: 10px;
    }

    .media-info {
      padding: 12px;
    }

    .media-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-date, .media-category {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .media-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .media-actions button {
      padding: 5px 10px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f0f0f0;
      color: #333;
      transition: background-color 0.2s;
    }

    .media-actions button:hover {
      background-color: #e0e0e0;
    }

    .media-actions .delete-btn {
      background-color: #ffeeee;
      color: #e53935;
    }

    .media-actions .delete-btn:hover {
      background-color: #ffdddd;
    }

    .media-placeholder {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: #888;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    /* Media Modal Styles */
    .media-modal-content {
      max-width: 800px;
      width: 90%;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      margin: auto;
      display: flex;
      flex-direction: column;
    }

    .media-display {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 4px;
    }

    .media-details {
      padding: 10px;
    }

    .media-details h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .media-details p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    /* Media type menu */
    .media-type-menu {
      z-index: 1000;
    }

    .media-type-menu button:hover {
      background-color: #f0f0f0;
    }
    
    /* Lists and List Items */
    ul, ol {
      text-align: center;
      padding-left: 0;
      list-style-position: inside;
    }
    
    li {
      text-align: center;
    }
    
    /* Session and Goal items */
    .session-item, .goal-item, .media-item {
      text-align: center;
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--gray-100);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      height: auto;
      min-height: 150px;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Only stretch items with notes */
    .session-item .session-notes:not(:empty) {
      height: auto;
    }
    
    .session-item:not(.has-notes) .session-notes,
    .goal-item:not(.has-notes) .goal-content,
    .media-item:not(.has-notes) .media-info {
      max-height: none;
    }
    
    /* Headers and Text Content */
    h1, h2, h3, h4, h5, h6, p {
      text-align: center;
    }
    
    /* Table alignment */
    table {
      margin: 0 auto;
      text-align: center;
    }
    
    th, td {
      text-align: center;
    }
    
    /* Notifications */
    .notification {
      text-align: center;
    }
    
    /* Custom dialog elements */
    .modal-content {
      text-align: center;
    }
    
    /* Footer */
    .footer {
      text-align: center;
    }
    
    /* Ensure dropdown text is centered */
    select option {
      text-align: center;
    }
    
    /* Center category items */
    .category-item {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .category-item .category-name {
      text-align: center;
    }
    
    .category-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    /* Session and goal styling for better centered appearance */
    .session-item {
      text-align: center;
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--gray-100);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .session-item:hover {
      background-color: var(--gray-200);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .session-item .session-info {
      width: 100%;
      text-align: center;
    }
    
    .session-item .session-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 1.1rem;
      color: var(--primary-color);
    }
    
    .session-item .session-details {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .session-item .session-notes {
      font-style: italic;
      color: var(--text-light);
      margin-bottom: 10px;
      padding: 5px;
      border-left: 3px solid var(--primary-light);
      background-color: rgba(255, 255, 255, 0.5);
    }
    
    .session-item .session-actions {
      margin-top: 10px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    /* Goal items styling */
    .goal-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 10px;
      background-color: var(--gray-100);
      transition: var(--transition);
    }
    
    .goal-item:hover {
      background-color: var(--gray-200);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .goal-item.completed {
      background-color: var(--success-light);
    }
    
    .goal-item .goal-checkbox {
      margin-right: 10px;
      cursor: pointer;
    }
    
    .goal-item .goal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .goal-item .goal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    /* Ensure icon inputs are properly centered */
    .icon-input {
      display: flex;
      justify-content: center;
      position: relative;
      width: 100%;
    }
    
    .icon-input svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      width: 20px;
      height: 20px;
    }
    
    .icon-input input,
    .icon-input select,
    .icon-input textarea {
      width: 100%;
      padding-left: 40px;
      text-align: center;
    }
    
    /* Adjust select dropdowns for better centering */
    select {
      text-align-last: center; /* Centers the selected item text */
      padding-right: 30px; /* Space for the dropdown arrow */
    }
    
    /* Chart elements centering */
    .chart-bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Media items centered */
    .media-item {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
      height: 280px; /* Fixed height for consistency */
    }
    
    .media-preview {
      height: 150px;
      width: 100%;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .media-info {
      padding: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .media-name {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      vertical-align: middle;
    }
    
    .media-date {
      font-size: 12px;
      color: #666;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }
    
    .media-category {
      font-size: 12px;
      color: #666;
      margin: 4px 0;
    }
    
    /* Fix any flexbox layouts to ensure centered content */
    .flex-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Ensure all divs have centered content by default */
    div {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <div>
        <div class="logo-text">
          <span class="practice">Practice</span><span class="track">Track</span>
        </div>
        <div class="tagline">Your musical journey companion</div>
        <div class="divider">
          <span class="music-note">♪</span>
          <div class="line"></div>
          <span class="music-note-orange">♪</span>
        </div>
      </div>
    </div>
    
    <ul class="menu">
      <li class="menu-item active" data-tab="timer">
        <span>Timer</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </li>
      <li class="menu-item" data-tab="sessions">
        <span>Sessions</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
      </li>
      <li class="menu-item" data-tab="goals">
        <span>Goals</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
          <path d="M9 12l2 2 4-4"></path>
        </svg>
      </li>
      <li class="menu-item" data-tab="dashboard">
        <span>Stats</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="3" y1="9" x2="21" y2="9"></line>
          <line x1="9" y1="21" x2="9" y2="9"></line>
        </svg>
      </li>
      <li class="menu-item" data-tab="media">
        <span>Media</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
      </li>
      <li class="menu-item" data-tab="settings">
        <span>Settings</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </li>
    </ul>
    
    <!-- Timer Tab -->
    <div id="timer-tab" class="tab active">
      <!-- Add How to Use button -->
      <button class="guide-button" id="show-guide" style="margin-bottom: 20px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        How to Use PracticeTrack
      </button>

      <div class="card timer-card">
        <div class="timer-content">
          <h2>Practice Timer</h2>
          <div id="timer-display" class="timer-display">00:00:00</div>
          <div class="timer-progress">
            <div id="timer-progress-bar" class="timer-progress-bar"></div>
          </div>
          
          <div class="controls">
            <button id="start-timer" class="start">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Start
            </button>
            <button id="pause-timer" class="pause" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
              </svg>
              Pause
            </button>
            <button id="resume-timer" class="resume hidden" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Resume
            </button>
            <button id="stop-timer" class="stop" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              </svg>
              Stop
            </button>
          </div>
        </div>
      </div>
      
      <!-- Timer Tab Form -->
      <div class="card">
        <div class="form-group">
          <label for="practice-category" class="required-field">Practice Category</label>
          <div class="icon-input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <select id="practice-category" required>
              <option value="">--Select Practice Category--</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="session-notes">Notes (optional)</label>
          <div class="icon-input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <textarea name="session-notes" id="session-notes" placeholder="Add any notes about your practice session..."></textarea>
          </div>
        </div>
        
        <button id="save-session" class="save-btn" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Session
        </button>
      </div>
      
      <div class="card">
        <h2>Metronome</h2>
        <div class="metronome-controls">
          <button class="metronome-button" id="decrease-tempo">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <div class="tempo-slider">
            <input type="range" id="tempo-slider" min="40" max="220" value="100">
          </div>
          <div class="bpm-display" id="bpm-display">100</div>
          <button class="metronome-button" id="increase-tempo">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <button class="metronome-button" id="start-metronome">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          </button>
          <button class="metronome-button hidden" id="stop-metronome">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="4" width="12" height="16"></rect>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Add footer -->
      <div class="footer">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>
    
    <!-- Sessions Tab -->
    <div id="sessions-tab" class="tab">
      <div class="card">
        <h2>Practice Sessions</h2>
        <button id="add-manual-session" class="guide-button" style="margin-bottom: 20px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Manual Session
        </button>
        
        <!-- Manual Session Form (initially hidden) -->
        <div id="manual-session-form" class="card" style="display: none; margin-bottom: 20px;">
          <h3>Add Manual Session</h3>
          <div class="form-group">
            <label for="manual-session-date" class="required-field">Date</label>
            <div class="icon-input">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <input type="date" id="manual-session-date" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="manual-session-hours" class="required-field">Duration</label>
            <div style="display: flex; gap: 10px;">
              <div class="icon-input" style="flex: 1;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <input type="number" id="manual-session-hours" min="0" max="24" placeholder="Hours" style="padding-left: 40px;">
              </div>
              <div class="icon-input" style="flex: 1;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <input type="number" id="manual-session-minutes" min="0" max="59" placeholder="Minutes" style="padding-left: 40px;">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="manual-session-category" class="required-field">Practice Category</label>
            <div class="icon-input">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              <select id="manual-session-category" required>
                <option value="">--Select Practice Category--</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="manual-session-notes">Notes (optional)</label>
            <div class="icon-input">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              <textarea id="manual-session-notes" placeholder="Add any notes about your practice session..."></textarea>
            </div>
          </div>
          
          <div class="controls">
            <button id="save-manual-session" class="save-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Save Session
            </button>
            <button id="cancel-manual-session" class="cancel-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Cancel
            </button>
          </div>
        </div>
        
        <div class="filter-controls">
          <div class="filter-group">
            <label for="session-date-filter">Time Period:</label>
            <select id="session-date-filter">
              <option value="this-week">This Week</option>
              <option value="this-month">This Month</option>
              <option value="ytd">Year to Date</option>
              <option value="year">Past Year</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="session-category-filter">Category:</label>
            <select id="session-category-filter">
              <option value="all">All Categories</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <input type="text" id="session-filter" placeholder="Filter sessions...">
        </div>
        <ul id="sessions-list" class="session-list"></ul>
        <div id="no-sessions-message" class="empty-message">
          <p>No practice sessions recorded yet. Use the timer to start tracking your practice!</p>
        </div>
      </div>
      <div class="footer">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>

    <!-- Goals Tab -->
    <div id="goals-tab" class="tab">
      <div class="card">
        <h2>Practice Goals</h2>
        <div class="filter-controls">
          <div class="filter-group">
            <label for="goal-date-filter">Time Period:</label>
            <select id="goal-date-filter">
              <option value="this-week">This Week</option>
              <option value="this-month">This Month</option>
              <option value="ytd">Year to Date</option>
              <option value="year">Past Year</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="goal-category-filter">Category:</label>
            <select id="goal-category-filter">
              <option value="all">All Categories</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <input type="text" id="goal-input" placeholder="Enter new goal..." required>
        </div>
        <div class="controls">
          <button id="add-goal" class="save-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Goal
          </button>
          <button id="update-goal" class="save-btn hidden">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Update Goal
          </button>
          <button id="cancel-edit" class="hidden">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Cancel
          </button>
        </div>
        <div class="form-group">
          <label for="goal-filter">Show: </label>
          <select id="goal-filter">
            <option value="all">All Goals</option>
            <option value="active" selected>Active</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <ul id="goals-list" class="goals-list"></ul>
        <div id="no-goals-message" class="empty-message">
          <p>No goals added yet. Add some goals to track your practice objectives!</p>
        </div>
      </div>
      <div class="footer">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab">
      <div class="card">
        <h2>Practice Statistics</h2>
        <div class="filter-controls">
          <div class="filter-group">
            <label for="dashboard-date-filter">Time Period:</label>
            <select id="dashboard-date-filter">
              <option value="this-week">This Week</option>
              <option value="this-month">This Month</option>
              <option value="ytd">Year to Date</option>
              <option value="year">Past Year</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="dashboard-category-filter">Category:</label>
            <select id="dashboard-category-filter">
              <option value="all">All Categories</option>
            </select>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-time">0h 0m</div>
            <div class="stat-label">Total Practice Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-sessions">0</div>
            <div class="stat-label">Total Sessions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avg-time">0m</div>
            <div class="stat-label">Average Session</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completed-goals">0 / 0</div>
            <div class="stat-label">Goals Completed</div>
          </div>
        </div>
        
        <div>
          <p>Instrument: <span id="instrument-display">None</span></p>
          <p>Lesson Day: <span id="lesson-day-display">None</span></p>
          <p id="next-lesson-text" style="display:none;">Next Lesson in <span id="days-to-lesson">0</span> days</p>
        </div>
        <div id="chart-container" class="chart-container"></div>
      </div>
      <div class="footer">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>
    
    <!-- Media Tab -->
    <div id="media-tab" class="tab">
      <div class="card">
        <h2 style="text-align: center;">Media Gallery</h2>
        
        <!-- Record button -->
        <div class="media-controls">
          <div style="display: flex; justify-content: center; align-items: center; margin: 30px 0;">
            <button id="camera-button" class="camera-button" style="margin: 0; padding: 12px 25px; font-size: 16px;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="3"></circle>
              </svg>
              Record
            </button>
            <button id="add-note-button" class="camera-button" style="margin-left: 15px; padding: 12px 25px; font-size: 16px; background-color: #2e7d32;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Note
            </button>
          </div>
          
          <div class="filter-controls" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 25px;">
            <div class="filter-group" style="min-width: 180px;">
              <label for="media-date-filter">Date Range:</label>
              <select id="media-date-filter" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            
            <div class="filter-group" style="min-width: 180px;">
              <label for="media-type-filter">Media Type:</label>
              <select id="media-type-filter" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="all">All Types</option>
                <option value="photo">Photos</option>
                <option value="video">Videos</option>
                <option value="note">Notes</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Media gallery -->
        <div id="media-gallery" class="media-gallery" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 10px;">
          <!-- Media items will be added here dynamically -->
        </div>
      </div>
      
      <div class="footer" style="text-align: center; margin-top: 20px;">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settings-tab" class="tab">
      <div class="card">
        <h2>Settings</h2>
        <div class="form-group">
          <label for="instrument">Instrument</label>
          <div class="icon-input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18V5l12-2v13"></path>
              <circle cx="6" cy="18" r="3"></circle>
              <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <select id="instrument" name="instrument" required>
              <option value="">--Select Instrument--</option>
              <option value="Piano">Piano</option>
              <option value="Guitar">Guitar</option>
              <option value="Violin">Violin</option>
              <option value="Drums">Drums</option>
              <option value="Voice">Voice</option>
              <option value="Bass Guitar">Bass Guitar</option>
              <option value="Saxophone">Saxophone</option>
              <option value="Flute">Flute</option>
              <option value="Trumpet">Trumpet</option>
              <option value="Cello">Cello</option>
              <option value="Clarinet">Clarinet</option>
              <option value="Trombone">Trombone</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="lesson-day">Lesson Day</label>
          <div class="icon-input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <select id="lesson-day" name="lesson-day">
              <option value="">--Select--</option>
              <option>Sunday</option>
              <option>Monday</option>
              <option>Tuesday</option>
              <option>Wednesday</option>
              <option>Thursday</option>
              <option>Friday</option>
              <option>Saturday</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="theme-select">Theme</label>
          <div class="icon-input">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <select id="theme-select">
              <option value="default">Default</option>
              <option value="dark">Dark Mode</option>
              <option value="light">Light Mode</option>
            </select>
          </div>
        </div>
        <button id="save-settings" class="save-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Settings
        </button>
      </div>
      
      <div class="card">
        <h2>Data Management</h2>
        <div class="controls">
          <button id="export-data" class="save-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export Data
          </button>
          <button id="import-data" class="save-btn" style="background-color: #f44336; color: white; border: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Replace All Data
          </button>
          <input type="file" id="import-file" accept=".json" class="hidden">
          <p class="warning-text" style="color: #c62828; font-weight: bold; font-size: 0.85rem; margin-top: 5px;">Warning: This will replace all your existing data and cannot be undone!</p>
        </div>
      </div>
      
      <div class="card">
        <h2>Category Management</h2>
        
        <div class="form-group">
          <label for="new-category-input">Add New Category</label>
          <div class="icon-input" style="display: flex; gap: 10px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <input type="text" id="new-category-input" placeholder="Enter new category name">
            <button id="add-category-btn" class="save-btn" style="width: auto; margin-top: 0;">
              Add
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <h3>Custom Categories</h3>
          <div id="categories-list" class="categories-list">
            <!-- Custom categories will be added here dynamically -->
            <p class="empty-message">No custom categories added yet</p>
          </div>
        </div>
        
        <div class="form-group">
          <h3>Default Categories</h3>
          <p class="hint" style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px;">Default categories can be hidden or shown. Hidden categories won't appear in dropdown menus.</p>
          <div id="default-categories-list" class="categories-list">
            <!-- Default categories will be added here dynamically -->
            <p class="empty-message">Please select an instrument first</p>
          </div>
        </div>
      </div>
      
      <div class="footer">
        © Mike Nelson Guitar Lessons | <a href="https://mikenelsonguitarlessons.co.nz" target="_blank">mikenelsonguitarlessons.co.nz</a>
      </div>
    </div>
    
    <!-- Add Guide Modal -->
    <div id="guide-modal" class="modal">
      <div class="modal-content">
        <button class="close-modal" id="close-guide">&times;</button>
        <div class="guide-content">
          <h2>How to Use PracticeTrack</h2>
          
          <div class="guide-section">
            <h3>Getting Started</h3>
            <p>Welcome to PracticeTrack, your musical practice companion! Follow these steps to get started:</p>
            <ol class="feature-list">
              <li>First, go to the Settings tab and select your instrument and regular lesson day (if applicable)</li>
              <li>Choose a theme that suits your preference (Default, Dark, or Light mode)</li>
              <li>Save your settings to personalize your practice experience</li>
            </ol>
          </div>
          
          <div class="guide-section">
            <h3>Using the Practice Timer</h3>
            <p>Track your practice sessions effectively:</p>
            <ul class="feature-list">
              <li>Use the Start button to begin your practice session</li>
              <li>Pause anytime if you need a break</li>
              <li>Resume when you're ready to continue</li>
              <li>Stop when you're done practicing</li>
              <li>Select a practice category and add optional notes</li>
              <li>Save your session to track your progress</li>
            </ul>
          </div>
          
          <div class="guide-section">
            <h3>Setting Goals</h3>
            <p>Stay motivated with practice goals:</p>
            <ul class="feature-list">
              <li>Add specific, achievable practice goals</li>
              <li>Mark goals as complete when achieved</li>
              <li>Filter goals by status (Active/Completed)</li>
              <li>Track your progress over time</li>
            </ul>
          </div>
          
          <div class="guide-section">
            <h3>Tracking Progress</h3>
            <p>Monitor your practice journey:</p>
            <ul class="feature-list">
              <li>View detailed practice statistics in the Dashboard</li>
              <li>Check your total practice time and session counts</li>
              <li>See your practice distribution across different categories</li>
              <li>Track days until your next lesson</li>
            </ul>
          </div>
          
          <div class="guide-section">
            <h3>Using the Metronome</h3>
            <p>Keep perfect time with the built-in metronome:</p>
            <ul class="feature-list">
              <li>Adjust tempo using the slider or +/- buttons</li>
              <li>Range from 40 to 220 BPM</li>
              <li>Start/stop with a single click</li>
            </ul>
          </div>
          
          <div class="guide-section">
            <h3>Data Management</h3>
            <p>Keep your practice data safe:</p>
            <ul class="feature-list">
              <li>Export your data for backup</li>
              <li>Import previously saved data</li>
              <li>All data is stored locally on your device</li>
            </ul>
          </div>
          
          <div class="guide-section">
            <h3>Camera Feature</h3>
            <p>Record your practice sessions on any device:</p>
            <ul class="feature-list">
              <li>Use the "Record" button below the metronome</li>
              <li>Take photos or record videos of your practice</li>
              <li>Switch between front and back cameras</li>
              <li>All media is stored locally on your device</li>
              <li>Media appears in your saved practice sessions</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Notification element -->
    <div id="notification" class="hidden"></div>
  </div>
  
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p class="loading-message">Processing...</p>
  </div>

  <script>
// Global variables
      let sessions = [];
      let goals = [];
      let settings = {
        instrument: "",
        lessonDay: "",
        theme: "default"
      };
      let customCategories = {}; // Format: {instrument: [category1, category2, ...]}
      let hiddenCategories = {}; // Format: {instrument: [category1, category2, ...]}
      let timerStatus = "stopped";
      let startTime = 0;
      let pausedTimeAccum = 0;
      let timerInterval = null;
      let metronomeInterval = null;
      let audioCtx = null;
      let notificationTimeout = null;
      let editingGoalId = null;
let elements = null;

// Instrument definitions and practice categories
const instrumentCategories = {
  "Piano": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Contemporary Songs",
    "Music Theory Study",
    "Chord Voicings",
    "Improvisation",
    "Songwriting"
  ],
  "Guitar": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Song Practice",
    "Music Theory Study",
    "Chords & Progressions",
    "Improvisation",
    "Songwriting"
  ],
  "Violin": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Folk & Contemporary",
    "Music Theory Study",
    "Bowing Practice",
    "Improvisation",
    "Songwriting"
  ],
  "Drums": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Groove & Timing",
    "Song Practice",
    "Music Theory Study",
    "Fills & Transitions",
    "Improvisation",
    "Songwriting"
  ],
  "Voice": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Contemporary Songs",
    "Music Theory Study",
    "Breath Support",
    "Improvisation",
    "Songwriting"
  ],
  "Bass Guitar": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Bass Lines",
    "Song Practice",
    "Music Theory Study",
    "Groove & Timing",
    "Improvisation",
    "Songwriting"
  ],
  "Saxophone": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Ensemble Material",
    "Music Theory Study",
    "Tone Development",
    "Improvisation",
    "Songwriting"
  ],
  "Flute": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Orchestral Material",
    "Music Theory Study",
    "Tone & Breathing",
    "Improvisation",
    "Songwriting"
  ],
  "Trumpet": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Ensemble Material",
    "Music Theory Study",
    "Range Building",
    "Improvisation",
    "Songwriting"
  ],
  "Cello": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Chamber Music",
    "Music Theory Study",
    "Bowing Practice",
    "Improvisation",
    "Songwriting"
  ],
  "Clarinet": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Ensemble Material",
    "Music Theory Study",
    "Tone & Breathing",
    "Improvisation",
    "Songwriting"
  ],
  "Trombone": [
    "Scales & Arpeggios",
    "Technique",
    "Sight Reading",
    "Classical Repertoire",
    "Ensemble Material",
    "Music Theory Study",
    "Slide Work",
    "Improvisation",
    "Songwriting"
  ]
};

// Initialize the application
function initializeApp() {
  console.log('Initializing application...');
  
  // Initialize DOM elements
  elements = {
        // Timer
        timerDisplay: document.getElementById('timer-display'),
        timerProgressBar: document.getElementById('timer-progress-bar'),
        startTimerBtn: document.getElementById('start-timer'),
        pauseTimerBtn: document.getElementById('pause-timer'),
        resumeTimerBtn: document.getElementById('resume-timer'),
        stopTimerBtn: document.getElementById('stop-timer'),
        
        // Session
    practiceCategory: document.getElementById('practice-category'),
    sessionNotes: document.getElementById('session-notes'),
        saveSessionBtn: document.getElementById('save-session'),
    sessionList: document.getElementById('sessions-list'),
        sessionFilter: document.getElementById('session-filter'),
        noSessionsMessage: document.getElementById('no-sessions-message'),
        
        // Goals
    goalName: document.getElementById('goal-input'),
        addGoalBtn: document.getElementById('add-goal'),
        updateGoalBtn: document.getElementById('update-goal'),
        cancelEditBtn: document.getElementById('cancel-edit'),
    goalList: document.getElementById('goals-list'),
        goalFilter: document.getElementById('goal-filter'),
        noGoalsMessage: document.getElementById('no-goals-message'),
        
        // Dashboard
        totalTime: document.getElementById('total-time'),
        totalSessions: document.getElementById('total-sessions'),
        avgTime: document.getElementById('avg-time'),
        completedGoals: document.getElementById('completed-goals'),
        instrumentDisplay: document.getElementById('instrument-display'),
        lessonDayDisplay: document.getElementById('lesson-day-display'),
        nextLessonText: document.getElementById('next-lesson-text'),
        daysToLesson: document.getElementById('days-to-lesson'),
    practiceChart: document.getElementById('chart-container'),
        
        // Settings
        instrument: document.getElementById('instrument'),
        lessonDay: document.getElementById('lesson-day'),
        themeSelect: document.getElementById('theme-select'),
        saveSettingsBtn: document.getElementById('save-settings'),
        exportDataBtn: document.getElementById('export-data'),
        importDataBtn: document.getElementById('import-data'),
        importFile: document.getElementById('import-file'),
        
        // Metronome
        tempoSlider: document.getElementById('tempo-slider'),
        bpmDisplay: document.getElementById('bpm-display'),
        decreaseTempoBtn: document.getElementById('decrease-tempo'),
        increaseTempoBtn: document.getElementById('increase-tempo'),
        startMetronomeBtn: document.getElementById('start-metronome'),
        stopMetronomeBtn: document.getElementById('stop-metronome'),
        
        // Notification
    notification: document.getElementById('notification'),
    
    // Add new filter elements
    sessionDateFilter: document.getElementById('session-date-filter'),
    sessionCategoryFilter: document.getElementById('session-category-filter'),
    goalDateFilter: document.getElementById('goal-date-filter'),
    goalCategoryFilter: document.getElementById('goal-category-filter'),
    dashboardDateFilter: document.getElementById('dashboard-date-filter'),
    dashboardCategoryFilter: document.getElementById('dashboard-category-filter'),
    
    // Add menu element
    menu: document.querySelector('.menu'),
    
    // Camera elements
    cameraButton: document.getElementById('camera-button'),
    
    // Category Management
    addCategoryBtn: document.getElementById('add-category-btn'),
    newCategoryInput: document.getElementById('new-category-input'),
    categoriesList: document.getElementById('categories-list'),
    defaultCategoriesList: document.getElementById('default-categories-list'),
  };
  
  // Verify elements and initialize
  if (verifyElements()) {
    console.log('Elements verified successfully');
    if (checkLocalStorage()) {
      console.log('localStorage available, initializing data...');
      initializeData();
    } else {
      console.log('localStorage not available, initializing UI only...');
      initUI();
    }
    
    // Show camera tip on all devices
    if (elements.cameraButton) {
      setTimeout(() => {
        notify('New feature: Record your practice using the camera button!', 'success');
      }, 2000);
    }
  } else {
    console.error('Failed to verify elements');
    notify('There was an error initializing the application.', 'error');
  }
}

function verifyElements() {
  console.log('Verifying DOM elements...');
  let missingElements = [];
  
  for (const [key, value] of Object.entries(elements)) {
    if (!value) {
      console.error(`Missing element: ${key}`);
      missingElements.push(key);
    }
  }
  
  if (missingElements.length > 0) {
    console.error('Missing elements:', missingElements);
    return false;
  }
  
  console.log('All DOM elements verified successfully');
  return true;
}

function checkLocalStorage() {
  try {
    localStorage.setItem('test', 'test');
    localStorage.removeItem('test');
    return true;
  } catch (e) {
    console.error('localStorage not available:', e);
    return false;
  }
}

      function initializeData() {
        try {
          const storedSessions = localStorage.getItem("sessions");
          if (storedSessions) {
            sessions = JSON.parse(storedSessions);
          }
          
          const storedGoals = localStorage.getItem("goals");
          if (storedGoals) {
            goals = JSON.parse(storedGoals);
          }
          
          settings.instrument = localStorage.getItem("instrument") || "";
          settings.lessonDay = localStorage.getItem("lessonDay") || "";
          settings.theme = localStorage.getItem("theme") || "default";
    
    // Initialize UI after data is loaded
    initUI();
    updatePracticeCategoryDropdown(); // Add this line
    
    const storedCustomCategories = localStorage.getItem("customCategories");
    if (storedCustomCategories) {
      customCategories = JSON.parse(storedCustomCategories);
    }
        } catch (error) {
          console.error("Error loading data from localStorage:", error);
          notify("There was an error loading your data.", "error");
        }
      }
      
      function initUI() {
        // Set theme
        applyTheme(settings.theme);
  
  // Update category filters
  updateCategoryFilters();
        
        // Populate initial UI with data
        updateDashboard();
        refreshSessionList();
        refreshGoalList();
        
        // Fill settings form fields
        elements.instrument.value = settings.instrument;
        if (settings.lessonDay) {
          elements.lessonDay.value = settings.lessonDay;
        }
        elements.themeSelect.value = settings.theme;
        
        // Set up event listeners
        setupEventListeners();
        
        // Update metronome display
        elements.bpmDisplay.textContent = elements.tempoSlider.value;
        
        // Initialize category dropdowns
        updateCategoryFilters();
        updateManualSessionCategoryDropdown();
        
        // Initialize category management
        initializeCustomCategories();
        refreshCategoriesList();
        updateAllCategoryDropdowns();
        
        // Set up category management event listeners
        if (elements.addCategoryBtn) {
          elements.addCategoryBtn.addEventListener('click', addCustomCategory);
        }
        
        if (elements.newCategoryInput) {
          elements.newCategoryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addCustomCategory();
            }
          });
        }
      }
      
      function setupEventListeners() {
  try {
        // Timer controls
        elements.startTimerBtn.addEventListener('click', startTimer);
        elements.pauseTimerBtn.addEventListener('click', pauseTimer);
        elements.resumeTimerBtn.addEventListener('click', resumeTimer);
        elements.stopTimerBtn.addEventListener('click', stopTimer);
        
    // Session management
        elements.saveSessionBtn.addEventListener('click', saveSession);
    elements.practiceCategory.addEventListener('change', () => {
      const isValid = elements.practiceCategory.value && timerStatus === "stopped" && pausedTimeAccum > 0;
      elements.saveSessionBtn.disabled = !isValid;
      elements.saveSessionBtn.classList.toggle('active-save', isValid);
    });
    elements.sessionNotes.addEventListener('input', () => {
      if (elements.practiceCategory.value && timerStatus === "stopped" && pausedTimeAccum > 0) {
        elements.saveSessionBtn.classList.add('active-save');
      }
    });
        elements.sessionFilter.addEventListener('input', refreshSessionList);
        
    // Manual Session Controls
    const addManualSessionBtn = document.getElementById('add-manual-session');
    const manualSessionForm = document.getElementById('manual-session-form');
    const saveManualSessionBtn = document.getElementById('save-manual-session');
    const cancelManualSessionBtn = document.getElementById('cancel-manual-session');
    
    if (addManualSessionBtn) {
      addManualSessionBtn.addEventListener('click', () => {
        showManualSessionForm();
      });
    }
    
    if (cancelManualSessionBtn) {
      cancelManualSessionBtn.addEventListener('click', () => {
        hideManualSessionForm();
      });
    }
    
    if (saveManualSessionBtn) {
      saveManualSessionBtn.addEventListener('click', () => {
        saveManualSession();
      });
    }
    
    // Set today's date as default for manual session
    const manualSessionDate = document.getElementById('manual-session-date');
    if (manualSessionDate) {
      const today = new Date().toISOString().split('T')[0];
      manualSessionDate.value = today;
    }
        
    // Goal management
    elements.goalName.addEventListener('input', () => {
      const isValid = elements.goalName.value.trim().length > 0;
      elements.addGoalBtn.classList.toggle('active-save', isValid);
    });
    elements.addGoalBtn.addEventListener('click', addGoal);
    elements.updateGoalBtn.addEventListener('click', updateGoal);
        elements.cancelEditBtn.addEventListener('click', cancelEditGoal);
        elements.goalFilter.addEventListener('change', refreshGoalList);
        
        // Settings
    elements.instrument.addEventListener('change', () => {
      const isValid = elements.instrument.value && elements.lessonDay.value;
      elements.saveSettingsBtn.classList.toggle('active-save', isValid);
    });
    elements.lessonDay.addEventListener('change', () => {
      const isValid = elements.instrument.value && elements.lessonDay.value;
      elements.saveSettingsBtn.classList.toggle('active-save', isValid);
    });
    elements.themeSelect.addEventListener('change', () => {
      elements.saveSettingsBtn.classList.add('active-save');
    });
    elements.saveSettingsBtn.addEventListener('click', saveSettings);

    // Export/Import
        elements.exportDataBtn.addEventListener('click', exportData);
    elements.importDataBtn.addEventListener('click', () => elements.importFile.click());
        elements.importFile.addEventListener('change', importData);

    // Tab navigation
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', () => {
        const tabName = item.getAttribute('data-tab');
        
        // Update active tab class
        document.querySelectorAll('.menu-item').forEach(menuItem => menuItem.classList.remove('active'));
        item.classList.add('active');
        
        // Hide all tabs and show the selected one
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // Save the active tab to localStorage
        localStorage.setItem("activeTab", `${tabName}-tab`);
        
        // Refresh UI when switching tabs
        if (tabName === 'dashboard') {
          updateDashboard();
        } else if (tabName === 'sessions') {
          refreshSessionList();
        } else if (tabName === 'goals') {
          refreshGoalList();
        }
      });
    });
        
        // Metronome controls
    elements.startMetronomeBtn.addEventListener('click', startMetronome);
    elements.stopMetronomeBtn.addEventListener('click', stopMetronome);
        elements.decreaseTempoBtn.addEventListener('click', () => changeTempo(-5));
        elements.increaseTempoBtn.addEventListener('click', () => changeTempo(5));
        elements.tempoSlider.addEventListener('input', () => {
          const tempo = parseInt(elements.tempoSlider.value);
          elements.bpmDisplay.textContent = tempo;
          if (metronomeInterval) {
            stopMetronome();
            startMetronome();
          }
        });
        
    // Filter event listeners
    elements.sessionDateFilter.addEventListener('change', refreshSessionList);
    elements.sessionCategoryFilter.addEventListener('change', refreshSessionList);
    elements.goalDateFilter.addEventListener('change', refreshGoalList);
    elements.goalCategoryFilter.addEventListener('change', refreshGoalList);
    elements.dashboardDateFilter.addEventListener('change', updateDashboard);
    elements.dashboardCategoryFilter.addEventListener('change', updateDashboard);

    // Add menu scroll handler
    if (elements.menu) {
      elements.menu.addEventListener('scroll', handleMenuScroll);
      window.addEventListener('resize', handleMenuScroll);
      // Check initial scroll state
      handleMenuScroll();
    }

    console.log('All event listeners set up successfully');
  } catch (error) {
    console.error('Error setting up event listeners:', error);
    notify('There was an error setting up the application controls.', 'error');
  }
      }
      
      // Timer functions
      function startTimer() {
  console.log('Starting timer...');
        if (timerStatus !== "stopped") return;
        
        pausedTimeAccum = 0;
        timerStatus = "running";
        startTime = Date.now();
        
        // Update button states
        elements.startTimerBtn.disabled = true;
        elements.pauseTimerBtn.disabled = false;
        elements.stopTimerBtn.disabled = false;
        elements.resumeTimerBtn.disabled = true;
  elements.resumeTimerBtn.classList.add('hidden');
  elements.pauseTimerBtn.classList.remove('hidden');
        elements.saveSessionBtn.disabled = true;
        
        // Start interval to update display
        timerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay(); // Update immediately
  console.log('Timer started successfully');
      }
      
      function pauseTimer() {
  console.log('Pausing timer...');
        if (timerStatus !== "running") return;
        
        clearInterval(timerInterval);
  pausedTimeAccum += Date.now() - startTime;
        timerStatus = "paused";
        
        // Update buttons
        elements.pauseTimerBtn.classList.add('hidden');
        elements.resumeTimerBtn.classList.remove('hidden');
        elements.resumeTimerBtn.disabled = false;
  console.log('Timer paused successfully');
      }
      
      function resumeTimer() {
  console.log('Resuming timer...');
        if (timerStatus !== "paused") return;
        
        startTime = Date.now();
  timerStatus = "running";
        
        // Update buttons
        elements.resumeTimerBtn.classList.add('hidden');
        elements.pauseTimerBtn.classList.remove('hidden');
        elements.pauseTimerBtn.disabled = false;
        
        timerInterval = setInterval(updateTimerDisplay, 1000);
  console.log('Timer resumed successfully');
      }
      
      function stopTimer() {
  console.log('Stopping timer...');
        if (timerStatus === "stopped") return;
        
        if (timerStatus === "running") {
          pausedTimeAccum += Date.now() - startTime;
        }
        
        clearInterval(timerInterval);
        timerStatus = "stopped";
        
        // Update displayed time one final time
        updateTimerDisplay();
        
        // Reset buttons
        elements.startTimerBtn.disabled = false;
        elements.pauseTimerBtn.disabled = true;
        elements.resumeTimerBtn.classList.add('hidden');
        elements.pauseTimerBtn.classList.remove('hidden');
        elements.stopTimerBtn.disabled = true;
        
  // Enable save button if we have a category and time recorded
  const isValid = elements.practiceCategory.value && pausedTimeAccum > 0;
  elements.saveSessionBtn.disabled = !isValid;
  elements.saveSessionBtn.classList.toggle('active-save', isValid);
  
  if (pausedTimeAccum === 0) {
          notify("No time recorded for this session.", "error");
        }
  console.log('Timer stopped successfully');
      }
      
      function updateTimerDisplay() {
        let elapsed = 0;
        
        if (timerStatus === "running") {
          elapsed = pausedTimeAccum + (Date.now() - startTime);
        } else {
          elapsed = pausedTimeAccum;
        }
        
        // Convert ms to HH:MM:SS
        const totalSeconds = Math.floor(elapsed / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        // Format with leading zeros
        const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        elements.timerDisplay.textContent = timeString;
        
        // Update progress bar (30 minutes = 100%)
        const progressPercent = Math.min(100, (elapsed / (30 * 60 * 1000)) * 100);
        elements.timerProgressBar.style.width = `${progressPercent}%`;
      }
      
// Utility functions
function formatDuration(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  if (hours > 0) {
    return `${hours}h ${minutes}m ${seconds}s`;
  } else if (minutes > 0) {
    return `${minutes}m ${seconds}s`;
  } else {
    return `${seconds}s`;
  }
}

function notify(message, type = "info") {
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
  }
  
  elements.notification.textContent = message;
  elements.notification.className = `notification ${type}`;
  elements.notification.classList.remove("hidden");
  
  notificationTimeout = setTimeout(() => {
    elements.notification.classList.add("hidden");
  }, 3000);
}

function applyTheme(theme) {
  document.body.className = theme;
  settings.theme = theme;
  localStorage.setItem("theme", theme);
}

// Session functions
function saveSession() {
  if (!elements.practiceCategory.value || timerStatus !== "stopped" || pausedTimeAccum === 0) {
    notify("Please select a practice category and stop the timer first.", "error");
          return;
        }
        
        const session = {
    id: Date.now(),
    name: elements.practiceCategory.value, // Using category as the name
          duration: pausedTimeAccum,
    date: new Date().toISOString(),
    notes: elements.sessionNotes.value.trim()
        };
        
        sessions.push(session);
        localStorage.setItem("sessions", JSON.stringify(sessions));
        
  // Reset form
  elements.practiceCategory.value = "";
  elements.sessionNotes.value = "";
        pausedTimeAccum = 0;
        elements.saveSessionBtn.disabled = true;
  elements.saveSessionBtn.classList.remove('active-save');
        
        // Update UI
        updateDashboard();
  refreshSessionList();
        notify("Session saved successfully!", "success");
      }
      
      function refreshSessionList() {
        const filterText = elements.sessionFilter.value.toLowerCase();
  const dateRange = getDateRange(elements.sessionDateFilter.value);
  const categoryFilter = elements.sessionCategoryFilter.value;
  
  const filteredSessions = sessions
    .filter(session => {
      const sessionDate = new Date(session.date);
      const matchesDate = sessionDate >= dateRange.start && sessionDate <= dateRange.end;
      const matchesCategory = categoryFilter === 'all' || session.name === categoryFilter;
      const matchesText = session.name.toLowerCase().includes(filterText);
      return matchesDate && matchesCategory && matchesText;
    })
    .sort((a, b) => b.id - a.id);
  
  elements.sessionList.innerHTML = "";
  elements.noSessionsMessage.style.display = filteredSessions.length === 0 ? "block" : "none";
  
  filteredSessions.forEach(session => {
          const li = document.createElement("li");
    li.className = "session-item";
    
    const duration = formatDuration(session.duration);
    const date = new Date(session.date).toLocaleDateString();
          
          li.innerHTML = `
            <div class="session-info">
        <div class="session-header">${session.name}</div>
        <div class="session-details">
          <span>Duration: ${duration}</span>
          <span>Date: ${date}</span>
        </div>
        ${session.notes ? `<p class="session-notes">${session.notes}</p>` : ""}
            </div>
            <div class="session-actions">
        <button class="delete-btn" data-id="${session.id}">Delete</button>
            </div>
          `;
          
    // Add event listener for delete
    li.querySelector(".delete-btn").addEventListener("click", () => deleteSession(session.id));
    
    elements.sessionList.appendChild(li);
  });
}

function editSession(id) {
  const session = sessions.find(s => s.id === id);
        if (!session) return;
        
        // Switch to timer tab
  document.querySelectorAll('.menu-item').forEach(menuItem => menuItem.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector('[data-tab="timer"]').classList.add('active');
  document.getElementById('timer-tab').classList.add('active');
        
  // Populate edit form
  elements.practiceCategory.value = session.name;
  elements.sessionNotes.value = session.notes || "";
        pausedTimeAccum = session.duration;
  
  // Remove old session
  sessions = sessions.filter(s => s.id !== id);
  localStorage.setItem("sessions", JSON.stringify(sessions));
  
  // Update UI
        updateTimerDisplay();
  refreshSessionList();
  updateDashboard();
  
  // Enable save button since we have valid data
  elements.saveSessionBtn.disabled = false;
  elements.saveSessionBtn.classList.add('active-save');
  
  notify("Session loaded for editing. Make your changes and save.", "info");
}

function deleteSession(id) {
  if (!confirm("Are you sure you want to delete this session?")) return;
  
  sessions = sessions.filter(s => s.id !== id);
        localStorage.setItem("sessions", JSON.stringify(sessions));
        
        updateDashboard();
  refreshSessionList();
  notify("Session deleted successfully!", "success");
      }
      
      // Goal functions
      function addGoal() {
  const goalName = elements.goalName.value.trim();
  if (!goalName) {
    notify("Please enter a goal description.", "error");
          return;
        }
        
        const goal = {
    id: Date.now(),
    name: goalName,
    completed: false,
    date: new Date().toISOString()
  };
  
        goals.push(goal);
        localStorage.setItem("goals", JSON.stringify(goals));
        
  elements.goalName.value = "";
  elements.addGoalBtn.classList.remove('active-save');
        refreshGoalList();
        updateDashboard();
  notify("Goal added successfully!", "success");
      }
      
      function updateGoal() {
  if (!editingGoalId || !elements.goalName.value.trim()) {
    notify("Please enter a goal description.", "error");
          return;
        }
        
        const goalIndex = goals.findIndex(g => g.id === editingGoalId);
        if (goalIndex === -1) return;
        
  goals[goalIndex].name = elements.goalName.value.trim();
        localStorage.setItem("goals", JSON.stringify(goals));
        
  cancelEditGoal();
        refreshGoalList();
  notify("Goal updated successfully!", "success");
      }
      
      function cancelEditGoal() {
        editingGoalId = null;
  elements.goalName.value = "";
  elements.addGoalBtn.classList.remove("hidden");
  elements.updateGoalBtn.classList.add("hidden");
  elements.cancelEditBtn.classList.add("hidden");
}

function refreshGoalList() {
  const dateRange = getDateRange(elements.goalDateFilter.value);
  const categoryFilter = elements.goalCategoryFilter.value;
  const showCompleted = elements.goalFilter.value === "completed";
  const showIncomplete = elements.goalFilter.value === "active";
  
  const filteredGoals = goals.filter(goal => {
    const goalDate = new Date(goal.date);
    const matchesDate = goalDate >= dateRange.start && goalDate <= dateRange.end;
    const matchesCategory = categoryFilter === 'all'; // Implement category for goals if needed
    const matchesStatus = showCompleted ? goal.completed : showIncomplete ? !goal.completed : true;
    return matchesDate && matchesCategory && matchesStatus;
  });
  
  elements.goalList.innerHTML = "";
  elements.noGoalsMessage.style.display = filteredGoals.length === 0 ? "block" : "none";
  
  filteredGoals.forEach(goal => {
    const li = document.createElement("li");
    li.className = goal.completed ? "completed" : "";
    
    li.innerHTML = `
      <div class="goal-checkbox ${goal.completed ? 'checked' : ''}" data-id="${goal.id}"></div>
      <span class="goal-text">${goal.name}</span>
      <div class="goal-actions">
        <button class="delete-btn">Delete</button>
      </div>
    `;
    
    // Add event listeners
    li.querySelector(".goal-checkbox").addEventListener("click", () => toggleGoal(goal.id));
    li.querySelector(".delete-btn").addEventListener("click", () => {
      if (confirm("Are you sure you want to delete this goal?")) {
        goals = goals.filter(g => g.id !== goal.id);
        localStorage.setItem("goals", JSON.stringify(goals));
        refreshGoalList();
        updateDashboard();
        notify("Goal deleted successfully!", "success");
      }
    });
    
    elements.goalList.appendChild(li);
  });
}

function toggleGoal(id) {
  const goal = goals.find(g => g.id === id);
  if (!goal) return;
  
  goal.completed = !goal.completed;
  localStorage.setItem("goals", JSON.stringify(goals));
  
  refreshGoalList();
  updateDashboard();
}

// Dashboard functions
function updateDashboard() {
  const dateRange = getDateRange(elements.dashboardDateFilter.value);
  const categoryFilter = elements.dashboardCategoryFilter.value;
  
  // Filter sessions based on date range and category
  const filteredSessions = sessions.filter(session => {
    const sessionDate = new Date(session.date);
    const matchesDate = sessionDate >= dateRange.start && sessionDate <= dateRange.end;
    const matchesCategory = categoryFilter === 'all' || session.name === categoryFilter;
    return matchesDate && matchesCategory;
  });
  
  // Calculate total practice time
  const totalTime = filteredSessions.reduce((acc, session) => acc + session.duration, 0);
  elements.totalTime.textContent = formatDuration(totalTime);
  
  // Update total sessions
  elements.totalSessions.textContent = filteredSessions.length;
  
  // Calculate average session time
  const avgTime = filteredSessions.length > 0 ? totalTime / filteredSessions.length : 0;
  elements.avgTime.textContent = formatDuration(avgTime);
  
  // Update the stats grid with only the three main stats
  const statsGrid = document.querySelector('.stats-grid');
  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value" id="total-time">${formatDuration(totalTime)}</div>
      <div class="stat-label">Total Practice Time</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="total-sessions">${filteredSessions.length}</div>
      <div class="stat-label">Total Sessions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="avg-time">${formatDuration(avgTime)}</div>
      <div class="stat-label">Average Session</div>
    </div>
  `;
  
  // Update instrument and lesson day display
  elements.instrumentDisplay.textContent = settings.instrument || "None";
  elements.lessonDayDisplay.textContent = settings.lessonDay || "None";
  
  // Calculate days until next lesson
  if (settings.lessonDay) {
    const today = new Date();
    const dayIndex = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
      .indexOf(settings.lessonDay);
    
    if (dayIndex !== -1) {
      let daysUntil = dayIndex - today.getDay();
      if (daysUntil <= 0) daysUntil += 7;
      
      elements.nextLessonText.style.display = "block";
      elements.daysToLesson.textContent = daysUntil;
    }
  } else {
    elements.nextLessonText.style.display = "none";
  }
}

function updatePracticeChart(dateRange, categoryFilter) {
  const dates = [];
  const now = new Date();
  let current = new Date(dateRange.start);
  
  while (current <= now) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }
  
  const minutesPerDay = dates.map(date => {
    const dayStart = new Date(date);
    const dayEnd = new Date(date);
    dayEnd.setDate(dayEnd.getDate() + 1);
    
    return sessions
      .filter(s => {
        const sessionDate = new Date(s.date);
        const matchesDate = sessionDate >= dayStart && sessionDate < dayEnd;
        const matchesCategory = categoryFilter === 'all' || s.name === categoryFilter;
        return matchesDate && matchesCategory;
      })
      .reduce((acc, s) => acc + (s.duration / (60 * 1000)), 0);
  });
  
  elements.practiceChart.innerHTML = "";
  
  minutesPerDay.forEach((minutes, i) => {
          const barContainer = document.createElement("div");
          barContainer.className = "chart-bar-container";
          
          const bar = document.createElement("div");
          bar.className = "chart-bar";
    bar.style.height = `${Math.min(100, (minutes / 60) * 100)}%`;
    
    const day = document.createElement("div");
    day.className = "chart-day";
    day.textContent = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][new Date(dates[i]).getDay()];
    
          barContainer.appendChild(bar);
    barContainer.appendChild(day);
    elements.practiceChart.appendChild(barContainer);
  });
      }
      
      // Settings functions
      function saveSettings() {
  try {
    const oldInstrument = settings.instrument;
    settings.instrument = elements.instrument.value.trim();
    settings.lessonDay = elements.lessonDay.value;
    settings.theme = elements.themeSelect.value;
    
    localStorage.setItem("instrument", settings.instrument);
    localStorage.setItem("lessonDay", settings.lessonDay);
    localStorage.setItem("theme", settings.theme);
    
    applyTheme(settings.theme);
    
    // Update category dropdowns if instrument changed
    if (oldInstrument !== settings.instrument) {
      console.log(`Instrument changed from ${oldInstrument} to ${settings.instrument}, updating category dropdowns...`);
      
      // Show loading overlay to indicate work in progress
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        document.querySelector('.loading-message').textContent = "Updating categories...";
        loadingOverlay.classList.add('show');
      }
      
      // Use setTimeout to allow the UI to update before doing the heavy work
      setTimeout(() => {
        try {
          // Update instrument categories
          if (!customCategories[settings.instrument]) {
            customCategories[settings.instrument] = [];
          }
          
          if (!hiddenCategories[settings.instrument]) {
            hiddenCategories[settings.instrument] = [];
          }
          
          // Update all category dropdowns
          updateAllCategoryDropdowns();
          
          // Refresh category lists in settings tab
          refreshCategoriesList();
          
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.classList.remove('show');
          }
          
          // Refresh all views without page reload
          updateDashboard();
          refreshSessionList();
          refreshGoalList();
          
          // Update instrument display
          if (elements.instrumentDisplay) {
            elements.instrumentDisplay.textContent = settings.instrument || "None";
          }
          
          // Update lesson day info
          if (elements.lessonDayDisplay) {
            elements.lessonDayDisplay.textContent = settings.lessonDay || "None";
          }
          
          // Calculate days until next lesson
          if (settings.lessonDay && elements.daysToLesson) {
            const today = new Date();
            const dayIndex = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
              .indexOf(settings.lessonDay);
            
            if (dayIndex !== -1) {
              let daysUntil = dayIndex - today.getDay();
              if (daysUntil <= 0) daysUntil += 7;
              
              elements.nextLessonText.style.display = "block";
              elements.daysToLesson.textContent = daysUntil;
            }
          } else if (elements.nextLessonText) {
            elements.nextLessonText.style.display = "none";
          }
          
          notify("Settings saved successfully!", "success");
        } catch (error) {
          console.error("Error updating categories:", error);
          if (loadingOverlay) {
            loadingOverlay.classList.remove('show');
          }
          notify("Error updating categories. Please try again.", "error");
        }
      }, 100); // Short delay to allow UI update
    } else {
      // If instrument didn't change, just refresh views
      updateDashboard();
      refreshSessionList();
      refreshGoalList();
      notify("Settings saved successfully!", "success");
    }
    
    elements.saveSettingsBtn.classList.remove('active-save');
  } catch (error) {
    console.error("Error saving settings:", error);
    notify("Failed to save settings.", "error");
  }
}

// Replace or update the updateAllCategoryDropdowns function
function updateAllCategoryDropdowns() {
  // First ensure the data structures exist
  if (!customCategories[settings.instrument]) {
    customCategories[settings.instrument] = [];
  }
  
  if (!hiddenCategories[settings.instrument]) {
    hiddenCategories[settings.instrument] = [];
  }

  // Update all category-related dropdowns
  updatePracticeCategoryDropdown();
  updateCategoryFilters();
  updateManualSessionCategoryDropdown();
  
  // Update category management UI
  refreshCategoriesList();
}

// Make sure getAllCategories properly handles missing data structures
function getAllCategories(instrument) {
  if (!instrument) return [];
  
  // Get default categories
  const defaultCats = instrumentCategories[instrument] || [];
  
  // Get hidden categories (ensure it exists)
  if (!hiddenCategories[instrument]) {
    hiddenCategories[instrument] = [];
  }
  const hiddenCats = hiddenCategories[instrument];
  
  // Get custom categories (ensure it exists)
  if (!customCategories[instrument]) {
    customCategories[instrument] = [];
  }
  const customCats = customCategories[instrument];
  
  // Combine all categories (excluding hidden ones)
  return [...defaultCats.filter(cat => !hiddenCats.includes(cat)), "Lesson", ...customCats];
}

// Update the refreshCategoriesList function to handle missing data
function refreshCategoriesList() {
  const categoriesList = document.getElementById('categories-list');
  const defaultCategoriesList = document.getElementById('default-categories-list');
  
  if (!categoriesList || !defaultCategoriesList) return;
  
  // Clear the lists
  categoriesList.innerHTML = '';
  defaultCategoriesList.innerHTML = '';
  
  if (!settings.instrument) {
    categoriesList.innerHTML = '<p class="empty-message">Please select an instrument first</p>';
    defaultCategoriesList.innerHTML = '<p class="empty-message">Please select an instrument first</p>';
    return;
  }
  
  // Ensure data structures exist
  if (!customCategories[settings.instrument]) {
    customCategories[settings.instrument] = [];
  }
  
  if (!hiddenCategories[settings.instrument]) {
    hiddenCategories[settings.instrument] = [];
  }
  
  // Get custom categories for this instrument
  const customCats = customCategories[settings.instrument] || [];
  
  // Show message if no custom categories
  if (customCats.length === 0) {
    categoriesList.innerHTML = '<p class="empty-message">No custom categories added yet</p>';
  } else {
    // Add custom categories
    customCats.forEach(category => {
      const div = document.createElement('div');
      div.className = 'category-item';
      div.innerHTML = `
        <span class="category-name">${category}</span>
        <div class="category-actions">
          <button class="delete-btn" onclick="deleteCustomCategory('${category}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      categoriesList.appendChild(div);
    });
  }
  
  // Get default categories and hidden status
  const defaultCats = instrumentCategories[settings.instrument] || [];
  const hiddenCats = hiddenCategories[settings.instrument] || [];
  
  // Add default categories
  defaultCats.forEach(category => {
    const isHidden = hiddenCats.includes(category);
    const div = document.createElement('div');
    div.className = 'category-item';
    
    if (isHidden) {
      div.classList.add('hidden-category');
    }
    
    div.innerHTML = `
      <span class="category-name">${category}</span>
      <div class="category-actions">
        <button class="toggle-btn" onclick="toggleDefaultCategory('${category}')">
          ${isHidden ? 
            `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>` : 
            `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
              <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>`
          }
        </button>
      </div>
    `;
    defaultCategoriesList.appendChild(div);
  });
}

// Data export/import functions
      function exportData() {
  try {
    const data = {
      sessions: sessions,
      goals: goals,
      settings: settings,
      customCategories: customCategories,
      hiddenCategories: hiddenCategories
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `PracticeTrack_Data_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
    notify("Data exported successfully!", "success");
  } catch (error) {
    console.error("Error exporting data:", error);
    notify("Failed to export data.", "error");
        }
      }
      
      function importData(e) {
  try {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
        const data = JSON.parse(e.target.result);
        
        if (!Array.isArray(data.sessions) || !Array.isArray(data.goals)) {
          throw new Error("Invalid data format");
        }
        
        sessions = data.sessions;
        goals = data.goals;
        settings = data.settings || { instrument: "", lessonDay: "", theme: "default" };
        
            localStorage.setItem("sessions", JSON.stringify(sessions));
            localStorage.setItem("goals", JSON.stringify(goals));
        localStorage.setItem("instrument", settings.instrument);
        localStorage.setItem("lessonDay", settings.lessonDay);
        localStorage.setItem("theme", settings.theme);
        
            applyTheme(settings.theme);
        initUI();
        
        notify("Data imported successfully!", "success");
      } catch (error) {
        console.error("Error parsing import data:", error);
        notify("Failed to import data: invalid format", "error");
      }
    };
    
    reader.readAsText(file);
    e.target.value = "";
  } catch (error) {
    console.error("Error importing data:", error);
    notify("Failed to import data.", "error");
  }
}

// Metronome functions
function startMetronome() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  if (metronomeInterval) {
    stopMetronome();
  }
  
  const bpm = parseInt(elements.tempoSlider.value);
  const intervalMs = (60 / bpm) * 1000;
  
  let tick = true;
  metronomeInterval = setInterval(() => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.frequency.value = tick ? 1000 : 800;
    gain.gain.value = 0.5;
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
    
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
    
    tick = !tick;
  }, intervalMs);
  
  elements.startMetronomeBtn.classList.add("hidden");
  elements.stopMetronomeBtn.classList.remove("hidden");
}

function stopMetronome() {
  if (metronomeInterval) {
    clearInterval(metronomeInterval);
    metronomeInterval = null;
  }
  
  elements.stopMetronomeBtn.classList.add("hidden");
  elements.startMetronomeBtn.classList.remove("hidden");
}

function changeTempo(delta) {
  const newTempo = parseInt(elements.tempoSlider.value) + delta;
  if (newTempo >= 40 && newTempo <= 208) {
    elements.tempoSlider.value = newTempo;
    elements.bpmDisplay.textContent = newTempo;
    
    if (metronomeInterval) {
      stopMetronome();
      startMetronome();
    }
  }
}

// Add this new function
function updatePracticeCategoryDropdown() {
  if (!settings.instrument) {
    elements.practiceCategory.innerHTML = '<option value="">Please select an instrument in Settings</option>';
    elements.practiceCategory.disabled = true;
    return;
  }

  const categories = [...instrumentCategories[settings.instrument] || [], "Lesson"];
  const options = categories.map(category => 
    `<option value="${category}">${category}</option>`
  ).join('');
  
  const filterDropdowns = [
    elements.sessionCategoryFilter,
    elements.goalCategoryFilter,
    elements.dashboardCategoryFilter,
    elements.practiceCategory
  ];
  
  filterDropdowns.forEach(dropdown => {
    if (dropdown) {
      dropdown.innerHTML = `
        <option value="all">All Categories</option>
        ${options}
      `;
      dropdown.disabled = false;
    }
  });
  
  // Practice category dropdown shouldn't have "All Categories" option
  if (elements.practiceCategory) {
    elements.practiceCategory.innerHTML = `
      <option value="">--Select Practice Category--</option>
      ${options}
    `;
  }
}

// Helper function to calculate practice statistics for the Excel export
function calculatePracticeStats() {
  const stats = [];
  
  // Calculate total practice time and session counts per instrument
  const instrumentStats = {};
  sessions.forEach(session => {
    const instrument = session.instrument || 'Unspecified';
    if (!instrumentStats[instrument]) {
      instrumentStats[instrument] = { 
        instrument: instrument, 
        totalDuration: 0, 
        sessionCount: 0,
        categories: {}
      };
    }
    
    instrumentStats[instrument].totalDuration += session.duration;
    instrumentStats[instrument].sessionCount++;
    
    // Track time per category within instrument
    const category = session.category || 'Unspecified';
    if (!instrumentStats[instrument].categories[category]) {
      instrumentStats[instrument].categories[category] = 0;
    }
    instrumentStats[instrument].categories[category] += session.duration;
  });
  
  // Add instrument summary rows
  for (const instrument in instrumentStats) {
    const data = instrumentStats[instrument];
    stats.push({
      Type: 'Instrument Summary',
      Instrument: instrument,
      Category: 'ALL',
      'Total Practice Time': formatTime(data.totalDuration),
      'Total Sessions': data.sessionCount,
      'Average Session Time': formatTime(data.totalDuration / data.sessionCount)
    });
    
    // Add category breakdown rows for each instrument
    for (const category in data.categories) {
      stats.push({
        Type: 'Category Breakdown',
        Instrument: instrument,
        Category: category,
        'Total Practice Time': formatTime(data.categories[category]),
        'Percentage of Instrument Time': `${Math.round((data.categories[category] / data.totalDuration) * 100)}%`,
        'Sessions': '-' // We don't track session count per category
      });
    }
  }
  
  // Add a grand total row
  const totalPracticeTime = sessions.reduce((total, session) => total + session.duration, 0);
  const totalSessions = sessions.length;
  stats.push({
    Type: 'Grand Total',
    Instrument: 'ALL',
    Category: 'ALL',
    'Total Practice Time': formatTime(totalPracticeTime),
    'Total Sessions': totalSessions,
    'Average Session Time': formatTime(totalSessions > 0 ? totalPracticeTime / totalSessions : 0)
  });
  
  // Add goal statistics
  const completedGoals = goals.filter(goal => goal.completed).length;
  const pendingGoals = goals.length - completedGoals;
  
  stats.push({
    Type: 'Goals Summary',
    Instrument: 'ALL',
    Category: 'ALL',
    'Completed Goals': completedGoals,
    'Pending Goals': pendingGoals,
    'Total Goals': goals.length
  });
  
  return stats;
}

// Add category management functions
function addCategory(categoryName) {
  if (!settings.instrument) {
    notify("Please select an instrument first", "error");
    return;
  }
  
  if (!categoryName.trim()) {
    notify("Please enter a category name", "error");
    return;
  }
  
  if (!customCategories[settings.instrument]) {
    customCategories[settings.instrument] = [];
  }
  
  if (getInstrumentCategories(settings.instrument).includes(categoryName)) {
    notify("This category already exists", "error");
    return;
  }
  
  customCategories[settings.instrument].push(categoryName);
  localStorage.setItem("customCategories", JSON.stringify(customCategories));
  refreshCategoriesList();
  updatePracticeCategoryDropdown();
  notify("Category added successfully!", "success");
}

function deleteCategory(categoryName) {
  if (!settings.instrument || !customCategories[settings.instrument]) return;
  
  const index = customCategories[settings.instrument].indexOf(categoryName);
  if (index === -1) return;
  
  if (confirm("Are you sure you want to delete this category? Any sessions using this category will be preserved.")) {
    customCategories[settings.instrument].splice(index, 1);
    localStorage.setItem("customCategories", JSON.stringify(customCategories));
    refreshCategoriesList();
    updatePracticeCategoryDropdown();
    notify("Category deleted successfully!", "success");
  }
}

function refreshCategoriesList() {
  const categoriesList = document.getElementById('categories-list');
  if (!categoriesList) return;
  
  categoriesList.innerHTML = '';
  
  if (!settings.instrument) {
    categoriesList.innerHTML = '<p class="empty-message">Please select an instrument first</p>';
    return;
  }
  
  const categories = getInstrumentCategories(settings.instrument);
  
  categories.forEach(category => {
    const isDefault = instrumentCategories[settings.instrument].includes(category);
    const div = document.createElement('div');
    div.className = 'category-item';
    div.innerHTML = `
      <span class="category-name">${category}</span>
      <div class="category-actions">
        ${!isDefault ? `
          <button class="delete-btn" onclick="deleteCategory('${category}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        ` : '<span class="badge">Default</span>'}
      </div>
    `;
    categoriesList.appendChild(div);
  });
}

// Add date filtering functions
function getDateRange(period) {
  const now = new Date();
  const start = new Date();
  
  switch (period) {
    case 'this-week':
      // If lesson day is set, use it as the start of the week
      if (settings.lessonDay) {
        const lessonDayIndex = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
          .indexOf(settings.lessonDay);
        const currentDayIndex = now.getDay();
        const diff = currentDayIndex - lessonDayIndex;
        start.setDate(now.getDate() - (diff >= 0 ? diff : diff + 7));
      } else {
        // Default to last 7 days
        start.setDate(now.getDate() - 7);
      }
      break;
    case 'this-month':
      start.setMonth(now.getMonth());
      start.setDate(1);
      break;
    case 'ytd':
      start.setMonth(0);
      start.setDate(1);
      break;
    case 'year':
      start.setFullYear(now.getFullYear() - 1);
      break;
    default:
      start.setFullYear(2000); // Effectively "all time"
  }
  
  start.setHours(0, 0, 0, 0);
  return { start, end: now };
}

// Wait for DOM to be fully loaded before initializing
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM fully loaded, initializing app...');
  initializeApp();
  
  // Restore active tab from localStorage if it exists
  const activeTabId = localStorage.getItem("activeTab");
  if (activeTabId) {
    const tabToActivate = document.getElementById(activeTabId);
    if (tabToActivate) {
      // Get menu items
      const menuItems = document.querySelectorAll('.menu-item');
      const tabs = document.querySelectorAll('.tab');
      
      // Find the corresponding menu item
      let menuItem;
      menuItems.forEach(item => {
        if (item.getAttribute('data-tab') === activeTabId.replace('-tab', '')) {
          menuItem = item;
        }
      });
      
      // Activate the correct tab
      if (menuItem) {
        // First remove active from all
        menuItems.forEach(item => item.classList.remove('active'));
        tabs.forEach(tab => tab.classList.remove('active'));
        
        // Then set active on the right ones
        menuItem.classList.add('active');
        tabToActivate.classList.add('active');
        
        console.log(`Restored active tab: ${activeTabId}`);
        
        // No longer remove the stored tab
        // localStorage.removeItem("activeTab");
      }
    }
  }
});

// Update category dropdowns when instrument changes
function updateCategoryFilters() {
  if (!settings.instrument) {
    const defaultOption = '<option value="">Please select an instrument in Settings</option>';
    const filterDropdowns = [
      elements.sessionCategoryFilter,
      elements.goalCategoryFilter,
      elements.dashboardCategoryFilter,
      elements.practiceCategory
    ];
    
    filterDropdowns.forEach(dropdown => {
      if (dropdown) {
        dropdown.innerHTML = defaultOption;
        dropdown.disabled = true;
      }
    });
    return;
  }

  const categories = [...instrumentCategories[settings.instrument] || [], "Lesson"];
  const options = categories.map(category => 
    `<option value="${category}">${category}</option>`
  ).join('');
  
  const filterDropdowns = [
    elements.sessionCategoryFilter,
    elements.goalCategoryFilter,
    elements.dashboardCategoryFilter,
    elements.practiceCategory
  ];
  
  filterDropdowns.forEach(dropdown => {
    if (dropdown) {
      dropdown.innerHTML = `
        <option value="all">All Categories</option>
        ${options}
      `;
      dropdown.disabled = false;
    }
  });
  
  // Practice category dropdown shouldn't have "All Categories" option
  if (elements.practiceCategory) {
    elements.practiceCategory.innerHTML = `
      <option value="">--Select Practice Category--</option>
      ${options}
    `;
  }
}

// Add this new function
function handleMenuScroll() {
  if (!elements.menu) return;
  
  const hasHorizontalScroll = elements.menu.scrollWidth > elements.menu.clientWidth;
  const isScrolledToEnd = elements.menu.scrollLeft + elements.menu.clientWidth >= elements.menu.scrollWidth - 10;
  
  elements.menu.classList.toggle('scroll-right', hasHorizontalScroll && !isScrolledToEnd);
}

// Add new event listeners for the guide modal
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM loaded - setting up guide and camera');
  
  const showGuideBtn = document.getElementById('show-guide');
  const closeGuideBtn = document.getElementById('close-guide');
  const guideModal = document.getElementById('guide-modal');
  
  if (showGuideBtn && closeGuideBtn && guideModal) {
    showGuideBtn.addEventListener('click', () => {
      guideModal.style.display = 'block';
    });
    
    closeGuideBtn.addEventListener('click', () => {
      guideModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    guideModal.addEventListener('click', (e) => {
      if (e.target === guideModal) {
        guideModal.style.display = 'none';
      }
    });
  }
  
  // Camera functionality
  const cameraButton = document.getElementById('camera-button');
  const cameraModal = document.getElementById('camera-modal');
  const cameraPreview = document.getElementById('camera-preview');
  const switchCameraBtn = document.getElementById('switch-camera');
  const takePhotoBtn = document.getElementById('take-photo');
  const startRecordingBtn = document.getElementById('start-recording');
  const stopRecordingBtn = document.getElementById('stop-recording');
  const closeCameraBtn = document.getElementById('close-camera');
  const mediaPreview = document.getElementById('media-preview');
  const photoPreview = document.getElementById('photo-preview');
  const videoPreview = document.getElementById('video-preview');
  const saveMediaBtn = document.getElementById('save-media');
  const cancelMediaBtn = document.getElementById('cancel-media');
  
  // Camera variables
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let facingMode = 'environment';
  let currentMediaType = null;
  let currentMediaBlob = null;
  
  // Initialize IndexedDB
  let db;
  const DB_NAME = 'PracticeTrackDB';
  const DB_VERSION = 1;
  
  function initializeDatabase() {
    console.log('Initializing IndexedDB...');
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onupgradeneeded = (event) => {
      console.log('Database upgrade needed, creating object stores');
      db = event.target.result;
      if (!db.objectStoreNames.contains('mediaFiles')) {
        const store = db.createObjectStore('mediaFiles', { keyPath: 'id' });
        store.createIndex('sessionId', 'sessionId', { unique: false });
      }
    };
    
    request.onsuccess = (event) => {
      db = event.target.result;
      console.log('Database initialized successfully');
      
      // Initialize media gallery if we're on the media tab
      if (document.getElementById('media-tab').classList.contains('active')) {
        loadMediaGallery();
      }
    };
    
    request.onerror = (event) => {
      console.error('Error opening database:', event.target.error);
      notify('Database error. Some features may not work properly.', 'error');
    };
  }
  
  // Initialize the database
  initializeDatabase();
  
  // Camera button (opens camera modal)
  if (cameraButton) {
    cameraButton.addEventListener('click', async () => {
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode }
        });
        
        cameraPreview.srcObject = stream;
        cameraModal.style.display = 'block';
      } catch (err) {
        console.error('Error accessing camera:', err);
        notify('Could not access camera. Please check permissions.', 'error');
      }
    });
  }
  
  // Switch camera button
  if (switchCameraBtn) {
    switchCameraBtn.addEventListener('click', async () => {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode }
        });
        
        cameraPreview.srcObject = stream;
      } catch (err) {
        console.error('Error switching camera:', err);
      }
    });
  }
  
  // Take photo button
  if (takePhotoBtn) {
    takePhotoBtn.addEventListener('click', () => {
      if (!stream) return;
      
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreview.videoWidth;
      canvas.height = cameraPreview.videoHeight;
      canvas.getContext('2d').drawImage(cameraPreview, 0, 0);
      
      canvas.toBlob(blob => {
        currentMediaType = 'photo';
        currentMediaBlob = blob;
        
        photoPreview.src = URL.createObjectURL(blob);
        photoPreview.classList.remove('hidden');
        videoPreview.classList.add('hidden');
        mediaPreview.classList.add('show');
      }, 'image/jpeg', 0.8);
    });
  }
  
  // Start recording button
  if (startRecordingBtn) {
    startRecordingBtn.addEventListener('click', () => {
      if (!stream) return;
      
      recordedChunks = [];
      
      try {
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          currentMediaType = 'video';
          currentMediaBlob = blob;
          
          videoPreview.src = URL.createObjectURL(blob);
          videoPreview.classList.remove('hidden');
          photoPreview.classList.add('hidden');
          mediaPreview.classList.add('show');
        };
        
        mediaRecorder.start();
        startRecordingBtn.classList.add('hidden');
        stopRecordingBtn.classList.remove('hidden');
      } catch (err) {
        console.error('Error starting recording:', err);
        notify('Could not start recording.', 'error');
      }
    });
  }
  
  // Stop recording button
  if (stopRecordingBtn) {
    stopRecordingBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        startRecordingBtn.classList.remove('hidden');
        stopRecordingBtn.classList.add('hidden');
      }
    });
  }
  
  // Close camera button
  if (closeCameraBtn) {
    closeCameraBtn.addEventListener('click', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      cameraModal.style.display = 'none';
      mediaPreview.classList.remove('show');
    });
  }
  
  // Save media button
  if (saveMediaBtn) {
    saveMediaBtn.addEventListener('click', () => {
      if (!currentMediaBlob) {
        console.error('Failed to save media: Media blob is missing');
        notify('Error: No media to save', 'error');
        return;
      }
      
      console.log('Saving media:', { type: currentMediaType });
      
      // Prompt for media name
      const mediaName = prompt('Enter a name for this recording:', '');
      const name = mediaName && mediaName.trim() !== '' ? mediaName.trim() : getNextUnnamedMedia();
      
      console.log('Media will be saved with name:', name);
      
      try {
        // Create a safe filename (remove invalid characters)
        const fileExtension = currentMediaType === 'photo' ? '.jpg' : '.mp4';
        const fileName = name.replace(/[^a-z0-9]/gi, '_') + fileExtension;
        
        // Create a downloadable URL from the blob
        const blobUrl = URL.createObjectURL(currentMediaBlob);
        
        // Create a download link
        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = fileName;
        
        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        const id = Date.now().toString();
        
        // Create media metadata record (without the blob)
        const mediaFile = {
          id: id,
          sessionId: currentSessionId || id,
          type: currentMediaType,
          name: name,
          fileName: fileName, // Store filename instead of blob
          timestamp: new Date().toISOString()
        };
        
        console.log('Saving media metadata to IndexedDB with ID:', id);
        
        // Save metadata to IndexedDB
        const transaction = db.transaction(['mediaFiles'], 'readwrite');
        const store = transaction.objectStore('mediaFiles');
        
        store.add(mediaFile).onsuccess = () => {
          console.log('Media metadata saved successfully to IndexedDB');
          
          // Detect iOS devices
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          
          if (isIOS) {
            // Show iOS-specific instructions
            notify('Media saved. For iOS: tap and hold on the opened image/video, then select "Save to Photos"', 'info', 8000);
          } else {
            notify(`${currentMediaType === 'photo' ? 'Photo' : 'Video'} saved to your Downloads folder as "${fileName}"`, 'success');
          }
          
          // Clean up the blob URL
          setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
          }, 100);
          
          mediaPreview.classList.remove('show');
          cameraModal.style.display = 'none';
          
          // Reset current media state
          currentMediaBlob = null;
          currentMediaType = null;
          
          // Switch to media tab and refresh gallery
          const mediaTabButton = document.querySelector('[data-tab="media"]');
          if (mediaTabButton) {
            mediaTabButton.click();
          }
        };
      } catch (error) {
        console.error('Error saving media:', error);
        notify('Error: Could not save media', 'error');
      }
    });
  }
  
  // Function to generate next unnamed media name
  function getNextUnnamedMedia() {
    const prefix = currentMediaType === 'photo' ? 'Unnamed Photo' : 'Unnamed Video';
    let counter = 1;
    
    if (db) {
      const transaction = db.transaction(['mediaFiles'], 'readonly');
      const store = transaction.objectStore('mediaFiles');
      
      const countRequest = store.count();
      countRequest.onsuccess = () => {
        counter = countRequest.result + 1;
      };
    }
    
    return `${prefix} ${counter}`;
  }
  
  // Cancel media button
  if (cancelMediaBtn) {
    cancelMediaBtn.addEventListener('click', () => {
      mediaPreview.classList.remove('show');
    });
  }
});

// Media tab functionality
document.addEventListener('DOMContentLoaded', () => {
  const mediaTab = document.querySelector('[data-tab="media"]');
  const mediaGallery = document.getElementById('media-gallery');
  const mediaDateFilter = document.getElementById('media-date-filter');
  const mediaCategoryFilter = document.getElementById('media-category-filter');
  const mediaTypeFilter = document.getElementById('media-type-filter');
  const viewMediaModal = document.getElementById('view-media-modal');
  
  let currentMediaId = null;
  let mediaCounter = 1;
  
  // Initialize media gallery when tab is clicked
  if (mediaTab) {
    mediaTab.addEventListener('click', function() {
      // Ensure we have a slight delay to allow the tab to become visible
      setTimeout(loadMediaGallery, 100);
    });
  }
  
  // Initialize media gallery on page load if we're already on the media tab
  if (document.getElementById('media-tab').classList.contains('active')) {
    loadMediaGallery();
  }
  
  // Initialize filters
  if (mediaDateFilter) {
    mediaDateFilter.addEventListener('change', loadMediaGallery);
  }
  
  if (mediaCategoryFilter) {
    mediaCategoryFilter.addEventListener('change', loadMediaGallery);
  }
  
  if (mediaTypeFilter) {
    mediaTypeFilter.addEventListener('change', loadMediaGallery);
  }
  
  // Load media gallery with filters
  function loadMediaGallery() {
    console.log('Loading media gallery...');
    
    if (!db) {
      console.error('Database not initialized');
      notify('Error: Database not initialized. Please refresh the page.', 'error');
      return;
    }
    
    // Debug: Check if mediaGallery element exists
    if (!mediaGallery) {
      console.error('Media gallery element not found');
      return;
    } else {
      console.log('Media gallery element found:', mediaGallery);
    }
    
    const dateFilter = mediaDateFilter ? mediaDateFilter.value : 'all';
    const categoryFilter = mediaCategoryFilter ? mediaCategoryFilter.value : 'all';
    const typeFilter = mediaTypeFilter ? mediaTypeFilter.value : 'all';
    
    console.log('Filters:', { dateFilter, categoryFilter, typeFilter });
    
    try {
      const transaction = db.transaction(['mediaFiles'], 'readonly');
      const store = transaction.objectStore('mediaFiles');
      
      console.log('Fetching media files from IndexedDB...');
      
      store.getAll().onsuccess = function(event) {
        const mediaFiles = event.target.result;
        console.log('Media files found:', mediaFiles ? mediaFiles.length : 0);
        
        if (mediaFiles && mediaFiles.length > 0) {
          // Debug: Log first media file structure
          console.log('Sample media file structure:', JSON.stringify(mediaFiles[0], (key, value) => {
            if (value instanceof Blob) return `Blob (${value.size} bytes, ${value.type})`;
            if (key === 'preview' && value) return 'Preview data present';
            return value;
          }, 2));
        }
        
        // Clear existing gallery
        if (mediaGallery) {
          mediaGallery.innerHTML = '';
          console.log('Cleared existing gallery content');
        }
        
        if (!mediaFiles || mediaFiles.length === 0) {
          console.log('No media files found, showing placeholder');
          const placeholder = document.createElement('div');
          placeholder.className = 'media-placeholder';
          placeholder.innerHTML = '<p>No media recordings yet. Use the "Record" button to capture photos or videos.</p>';
          mediaGallery.appendChild(placeholder);
          return;
        }
        
        // Apply filters
        let filteredMedia = mediaFiles;
        
        // Date filter
        if (dateFilter !== 'all') {
          const now = new Date();
          let startDate;
          
          switch (dateFilter) {
            case 'today':
              startDate = new Date(now.setHours(0, 0, 0, 0));
              break;
            case 'week':
              startDate = new Date(now.setDate(now.getDate() - now.getDay()));
              break;
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              break;
            case 'year':
              startDate = new Date(now.getFullYear(), 0, 1);
              break;
          }
          
          filteredMedia = filteredMedia.filter(media => {
            try {
              const mediaDate = new Date(media.timestamp);
              return mediaDate >= startDate;
            } catch (error) {
              console.error('Error parsing date:', error, media);
              return true; // Include media with invalid dates
            }
          });
        }
        
        // Category filter
        if (categoryFilter !== 'all') {
          filteredMedia = filteredMedia.filter(media => {
            // Link to session data to get category
            const session = getSavedSession(media.sessionId);
            return session && session.category === categoryFilter;
          });
        }
        
        // Type filter
        if (typeFilter !== 'all') {
          filteredMedia = filteredMedia.filter(media => media.type === typeFilter);
        }
        
        // Sort by timestamp (newest first)
        filteredMedia.sort((a, b) => {
          try {
            return new Date(b.timestamp) - new Date(a.timestamp);
          } catch (error) {
            console.error('Error sorting by date:', error);
            return 0;
          }
        });
        
        console.log('Filtered media files:', filteredMedia.length);
        
        // Render filtered media
        filteredMedia.forEach(media => {
          try {
            const mediaItem = createMediaItem(media);
            mediaGallery.appendChild(mediaItem);
          } catch (error) {
            console.error('Error creating media item:', error, media);
          }
        });
        
        if (filteredMedia.length === 0) {
          const placeholder = document.createElement('div');
          placeholder.className = 'media-placeholder';
          placeholder.innerHTML = '<p>No media found matching your filters.</p>';
          mediaGallery.appendChild(placeholder);
        }
      };
      
      store.getAll().onerror = function(event) {
        console.error('Error fetching media files:', event.target.error);
        notify('Error loading media. Please refresh the page.', 'error');
      };
      
      // Update the category filter options with available categories
      updateCategoryFilter();
    } catch (error) {
      console.error('Error in loadMediaGallery:', error);
      notify('Error loading media gallery', 'error');
    }
  }
  
  // Make loadMediaGallery available globally
  window.loadMediaGallery = loadMediaGallery;
  
  // Create a media item element
  function createMediaItem(media) {
    try {
      const mediaItem = document.createElement('div');
      mediaItem.className = 'media-item';
      mediaItem.dataset.id = media.id;
      
      // Validate that we have a blob
      if (!media.blob || !(media.blob instanceof Blob)) {
        console.error('Invalid media blob for item:', media);
        
        // Create a placeholder instead
        mediaItem.innerHTML = `
          <div class="media-preview" style="background-color: #f8f8f8; display: flex; align-items: center; justify-content: center;">
            <div style="text-align: center; padding: 20px;">
              <p>Media preview unavailable</p>
            </div>
          </div>
          <div class="media-info">
            <div class="media-name">${media.name || 'Unnamed Media'}</div>
            <div class="media-date">${new Date(media.timestamp).toLocaleString()}</div>
            <div class="media-actions">
              <button class="delete-btn">Delete</button>
            </div>
          </div>
        `;
        
        // Add delete button event listener
        const deleteBtn = mediaItem.querySelector('.delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this media? This cannot be undone.')) {
              deleteMedia(media.id);
            }
          });
        }
        
        return mediaItem;
      }
      
      // Get session data if available
      const session = getSavedSession(media.sessionId);
      const category = session ? session.category : 'Uncategorized';
      
      // Format the date
      const mediaDate = new Date(media.timestamp);
      const formattedDate = `${mediaDate.toLocaleDateString()} ${mediaDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      
      // Get media name (or use default)
      const mediaName = media.name || `Unnamed ${mediaCounter++}`;
      
      // Create preview based on media type
      let previewContent;
      try {
        const blobUrl = URL.createObjectURL(media.blob);
        previewContent = media.type === 'photo' 
          ? `<img src="${blobUrl}" alt="${mediaName}">` 
          : `<video src="${blobUrl}" preload="metadata"></video>`;
      } catch (error) {
        console.error('Error creating blob URL:', error);
        previewContent = `<div class="media-error">Error loading preview</div>`;
      }
      
      // Create type icon
      const typeIcon = media.type === 'photo'
        ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`
        : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`;
      
      mediaItem.innerHTML = `
        <div class="media-preview">
          ${previewContent}
        </div>
        <div class="media-info">
          <div class="media-name">${mediaName}</div>
          <div class="media-date">${formattedDate}</div>
          <div class="media-category">${category}</div>
          <div class="media-actions">
            <button class="view-btn">View</button>
            <button class="rename-btn">Rename</button>
            <button class="delete-btn">Delete</button>
          </div>
        </div>
      `;
      
      // Add event listeners to buttons
      const viewBtn = mediaItem.querySelector('.view-btn');
      const renameBtn = mediaItem.querySelector('.rename-btn');
      const deleteBtn = mediaItem.querySelector('.delete-btn');
      
      if (viewBtn) {
        viewBtn.addEventListener('click', () => {
          viewMedia(media);
        });
      }
      
      if (renameBtn) {
        renameBtn.addEventListener('click', () => {
          const newName = prompt('Enter new name:', mediaName);
          if (newName && newName.trim() !== '') {
            updateMediaName(media.id, newName.trim());
          }
        });
      }
      
      if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to delete this media? This cannot be undone.')) {
            deleteMedia(media.id);
          }
        });
      }
      
      return mediaItem;
    } catch (error) {
      console.error('Error creating media item:', error);
      
      // Return a simple fallback element if there's an error
      const errorItem = document.createElement('div');
      errorItem.className = 'media-item';
      errorItem.style.backgroundColor = '#ffeeee';
      errorItem.innerHTML = `
        <div class="media-info">
          <div class="media-name">Error displaying media</div>
          <div class="media-actions">
            <button class="delete-btn">Delete</button>
          </div>
        </div>
      `;
      
      const deleteBtn = errorItem.querySelector('.delete-btn');
      if (deleteBtn && media && media.id) {
        deleteBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to delete this media? This cannot be undone.')) {
            deleteMedia(media.id);
          }
        });
      }
      
      return errorItem;
    }
  }
  
  // View media in modal
  function viewMedia(media) {
    if (!viewMediaModal) return;
    
    try {
      currentMediaId = media.id;
      
      const viewContent = viewMediaModal.querySelector('.view-media-content');
      if (!viewContent) return;
      
      viewContent.innerHTML = '';
      
      // Determine how to display the media
      let mediaDisplay = '';
      let mediaUrl = '';
      
      // Check for preview or blob in different formats
      if (media.preview instanceof Blob) {
        mediaUrl = URL.createObjectURL(media.preview);
        
        if (media.type === 'photo') {
          mediaDisplay = `<img src="${mediaUrl}" alt="${media.name}" style="max-width: 100%; max-height: 70vh;">`;
        } else {
          mediaDisplay = `
            <div style="text-align: center; color: var(--text-color);">
              <img src="${mediaUrl}" alt="${media.name}" style="max-width: 100%; max-height: 50vh;">
              <p>Preview only. To view the actual video, please check your device files.</p>
            </div>`;
        }
      } else if (media.blob instanceof Blob) {
        mediaUrl = URL.createObjectURL(media.blob);
        
        if (media.type === 'photo') {
          mediaDisplay = `<img src="${mediaUrl}" alt="${media.name}" style="max-width: 100%; max-height: 70vh;">`;
        } else {
          mediaDisplay = `
            <video controls style="max-width: 100%; max-height: 70vh;">
              <source src="${mediaUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;
        }
      } else {
        // No preview available, show text-only info
        mediaDisplay = `
          <div style="background-color: var(--background-light); padding: 30px; text-align: center; color: var(--text-color);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              ${media.type === 'photo' 
                ? '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>'
                : '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>'
              }
            </svg>
          </div>`;
      }
      
      // Create the full content display
      viewContent.innerHTML = `
        <div class="media-modal-content">
          <div class="media-display">
            ${mediaDisplay}
          </div>
          <div class="media-details">
            <h3>${media.name}</h3>
            <p>File: ${media.fileName || 'Unknown filename'}</p>
            <p>Date: ${new Date(media.timestamp).toLocaleString()}</p>
            <p>Type: ${media.type === 'photo' ? 'Photo' : 'Video'}</p>
            ${media.sessionId ? `<p>Session: ${media.sessionId}</p>` : ''}
          </div>
        </div>
      `;
      
      // Show the modal
      viewMediaModal.style.display = 'flex';
      
      // Clean up when modal is closed
      const closeButton = viewMediaModal.querySelector('.close-modal');
      if (closeButton) {
        const cleanup = () => {
          if (mediaUrl) URL.revokeObjectURL(mediaUrl);
          closeButton.removeEventListener('click', cleanup);
        };
        
        closeButton.addEventListener('click', cleanup, { once: true });
      }
      
    } catch (error) {
      console.error('Error displaying media info:', error);
      notify('Error displaying media information. Please try again.', 'error');
    }
  }
  
  // Update media name
  function updateMediaName(mediaId, newName) {
    if (!db) return;
    
    const transaction = db.transaction(['mediaFiles'], 'readwrite');
    const store = transaction.objectStore('mediaFiles');
    
    const request = store.get(mediaId);
    
    request.onsuccess = function(event) {
      const media = event.target.result;
      
      if (media) {
        media.name = newName;
        
        store.put(media).onsuccess = function() {
          notify('Media record renamed successfully', 'success');
          notify('Note: This only changes the name in the app, not the file on your device', 'info');
          loadMediaGallery();
        };
      }
    };
  }
  
  // Delete media record (not the actual file)
  function deleteMedia(mediaId) {
    if (!db) return;
    
    const transaction = db.transaction(['mediaFiles'], 'readwrite');
    const store = transaction.objectStore('mediaFiles');
    
    store.delete(mediaId).onsuccess = function() {
      notify('Media record deleted successfully', 'success');
      notify('The actual file remains on your device', 'info');
      
      // Close modal if open
      if (currentMediaId === mediaId && viewMediaModal.style.display === 'flex') {
        viewMediaModal.style.display = 'none';
      }
      
      loadMediaGallery();
    };
  }
  
  // Update category filter with available categories from practice sessions
  function updateCategoryFilter() {
    if (!mediaCategoryFilter) return;
    
    // Keep the first option (All Categories)
    const firstOption = mediaCategoryFilter.options[0];
    mediaCategoryFilter.innerHTML = '';
    mediaCategoryFilter.appendChild(firstOption);
    
    // Initialize categories Set
    const categories = new Set();
    
    // Add categories from practice sessions
    if (localStorage.getItem('practiceSessions')) {
      try {
        const sessions = JSON.parse(localStorage.getItem('practiceSessions'));
        
        if (Array.isArray(sessions)) {
          sessions.forEach(session => {
            if (session && session.category && typeof session.category === 'string') {
              categories.add(session.category);
            }
          });
        }
      } catch (error) {
        console.error('Error parsing practice sessions:', error);
      }
    }
    
    // Add "Lesson" as a category
    categories.add("Lesson");
    
    // Add categories from media files directly
    if (db) {
      const transaction = db.transaction(['mediaFiles'], 'readonly');
      const store = transaction.objectStore('mediaFiles');
      
      store.getAll().onsuccess = function(event) {
        const mediaFiles = event.target.result;
        
        if (Array.isArray(mediaFiles)) {
          // Get all session IDs from media files
          const sessionIds = new Set();
          mediaFiles.forEach(media => {
            if (media && media.sessionId) {
              sessionIds.add(media.sessionId);
            }
          });
          
          // Look up each session to get its category
          if (localStorage.getItem('practiceSessions')) {
            try {
              const sessions = JSON.parse(localStorage.getItem('practiceSessions'));
              
              if (Array.isArray(sessions)) {
                sessionIds.forEach(sessionId => {
                  const session = sessions.find(s => s.id === sessionId);
                  if (session && session.category) {
                    categories.add(session.category);
                  }
                });
              }
            } catch (error) {
              console.error('Error parsing practice sessions:', error);
            }
          }
        }
        
        // Add categories to filter
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          mediaCategoryFilter.appendChild(option);
        });
      };
    } else {
      // If no IndexedDB, still add the categories we've found
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        mediaCategoryFilter.appendChild(option);
      });
    }
  }
  
  // Helper function to get session by ID
  function getSavedSession(sessionId) {
    if (!sessionId || !localStorage.getItem('practiceSessions')) {
      return null;
    }
    
    const sessions = JSON.parse(localStorage.getItem('practiceSessions'));
    return sessions.find(session => session.id === sessionId);
  }
  
  // Setup event listeners for media modal
  if (viewMediaModal) {
    const closeBtn = document.getElementById('close-view-media');
    const renameBtn = document.getElementById('rename-media');
    const deleteBtn = document.getElementById('delete-media');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        viewMediaModal.style.display = 'none';
        const videoElement = viewMediaModal.querySelector('video');
        if (videoElement) {
          videoElement.pause();
        }
      });
    }
    
    if (renameBtn) {
      renameBtn.addEventListener('click', () => {
        if (!currentMediaId) return;
        
        const transaction = db.transaction(['mediaFiles'], 'readonly');
        const store = transaction.objectStore('mediaFiles');
        
        store.get(currentMediaId).onsuccess = function(event) {
          const media = event.target.result;
          
          if (media) {
            const newName = prompt('Enter new name:', media.name || '');
            if (newName && newName.trim() !== '') {
              updateMediaName(currentMediaId, newName.trim());
            }
          }
        };
      });
    }
    
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (!currentMediaId) return;
        
        if (confirm('Are you sure you want to delete this media? This cannot be undone.')) {
          deleteMedia(currentMediaId);
        }
      });
    }
  }
});

// Add camera functionality
document.addEventListener('DOMContentLoaded', function() {
  const openCameraBtn = document.getElementById('open-camera');
  const cameraModal = document.getElementById('camera-modal');
  const closeCameraBtn = document.getElementById('close-camera');
  const switchCameraBtn = document.getElementById('switch-camera');
  const takePictureBtn = document.getElementById('take-picture');
  const cameraPreview = document.getElementById('camera-preview');
  
  // Initialize camera variables if not already defined
  if (typeof stream === 'undefined') {
    let stream = null;
  }
  if (typeof facingMode === 'undefined') {
    let facingMode = 'environment'; // Start with rear camera
  }
  
  if (openCameraBtn) {
    openCameraBtn.addEventListener('click', function() {
      startCamera();
      if (cameraModal) {
        cameraModal.style.display = 'flex';
      }
    });
  }
  
  if (closeCameraBtn) {
    closeCameraBtn.addEventListener('click', function() {
      stopCamera();
      if (cameraModal) {
        cameraModal.style.display = 'none';
      }
    });
  }
  
  if (switchCameraBtn) {
    switchCameraBtn.addEventListener('click', function() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      stopCamera();
      startCamera();
    });
  }
  
  if (takePictureBtn) {
    takePictureBtn.addEventListener('click', takePhoto);
  }
});

// Camera functions
function startCamera() {
  const cameraPreview = document.getElementById('camera-preview');
  if (!cameraPreview) return;
  
  // Stop any existing stream
  stopCamera();
  
  // Get camera access
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: facingMode },
    audio: false
  })
  .then(function(newStream) {
    stream = newStream;
    cameraPreview.srcObject = stream;
    cameraPreview.play();
  })
  .catch(function(err) {
    console.error('Error accessing camera:', err);
    alert('Could not access camera. Please check permissions and try again.');
  });
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  
  const cameraPreview = document.getElementById('camera-preview');
  if (cameraPreview) {
    cameraPreview.srcObject = null;
  }
}

function takePhoto() {
  const cameraPreview = document.getElementById('camera-preview');
  if (!cameraPreview || !stream) return;
  
  try {
    // Create a canvas element to capture the image
    const canvas = document.createElement('canvas');
    canvas.width = cameraPreview.videoWidth;
    canvas.height = cameraPreview.videoHeight;
    
    // Draw the video frame to the canvas
    const ctx = canvas.getContext('2d');
    ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
    
    // Convert to data URL for preview
    const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
    
    // Close camera modal and open preview modal
    stopCamera();
    const cameraModal = document.getElementById('camera-modal');
    if (cameraModal) {
      cameraModal.style.display = 'none';
    }
    
    // Show preview and save options
    const mediaPreviewEl = document.getElementById('media-preview');
    const photoPreviewEl = document.getElementById('photo-preview');
    const videoPreviewEl = document.getElementById('video-preview');
    
    if (mediaPreviewEl && photoPreviewEl) {
      // Show the photo preview
      photoPreviewEl.src = imageDataUrl;
      photoPreviewEl.classList.remove('hidden');
      if (videoPreviewEl) videoPreviewEl.classList.add('hidden');
      
      // Show the preview modal
      mediaPreviewEl.style.display = 'flex';
      
      // Set up save button handler
      const saveBtn = document.getElementById('save-media');
      const cancelBtn = document.getElementById('cancel-media');
      
      if (saveBtn) {
        // Prompt for media name immediately
        const mediaName = prompt('Name this photo:', '');
        if (mediaName === null) {
          // User cancelled, close preview
          mediaPreviewEl.style.display = 'none';
          return;
        }
        
        const fileName = (mediaName || 'PracticeTrack_Photo_' + new Date().toLocaleTimeString()).replace(/[^a-z0-9]/gi, '_') + '.jpg';
        
        // Convert the canvas to a blob and download immediately
        canvas.toBlob(function(blob) {
          if (!blob) {
            console.error('Could not create image blob');
            return;
          }
          
          // Create and trigger download link
          const link = document.createElement('a');
          link.download = fileName;
          link.href = URL.createObjectURL(blob);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Create unique ID for the media record
          const mediaId = 'media_' + Date.now();
          
          // Get current session if available
          const currentSessionId = getCurrentSessionId();
          
          // Create text-only media record
          const mediaRecord = {
            id: mediaId,
            type: 'photo',
            name: mediaName || 'Photo ' + new Date().toLocaleTimeString(),
            fileName: fileName,
            timestamp: Date.now(),
            sessionId: currentSessionId
          };
          
          // Save text record to IndexedDB
          saveMediaRecord(mediaRecord);
          
          // Show success message
          notify('Photo saved as "' + fileName + '"', 'success');
          
          // For iOS, show special instructions
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          if (isIOS) {
            setTimeout(function() {
              alert('On iOS: The image should have opened in a new tab. Tap and hold the image, then select "Save to Photos"');
            }, 500);
          }
          
          // Change save button to show success
          saveBtn.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          `;
          saveBtn.style.backgroundColor = '#4CAF50';
        }, 'image/jpeg', 0.8);
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          mediaPreviewEl.style.display = 'none';
        });
      }
    }
  } catch (error) {
    console.error('Error taking photo:', error);
    notify('Error capturing photo. Please try again.', 'error');
  }
}

// Save text-only media record to IndexedDB
function saveMediaRecord(mediaRecord) {
  initDB().then(function() {
    if (!db) {
      console.error('Database not available');
      return;
    }
    
    const transaction = db.transaction(['mediaFiles'], 'readwrite');
    const store = transaction.objectStore('mediaFiles');
    
    // Make sure we're not accidentally storing a blob
    const safeRecord = { ...mediaRecord };
    if (safeRecord.blob) {
      console.log('Removing blob from record to store metadata only');
      delete safeRecord.blob;
    }
    
    store.add(safeRecord).onsuccess = function() {
      console.log('Media record saved successfully');
      // Load media gallery if on media tab
      if (document.querySelector('.tab-content.active#media-tab')) {
        loadMediaGallery();
      }
    };
  });
}

// Helper to get current session ID
function getCurrentSessionId() {
  const activeSession = document.querySelector('.timer-display[data-session-id]');
  return activeSession ? activeSession.dataset.sessionId : null;
}

// Create a media item element
function createMediaItem(media) {
  try {
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.dataset.id = media.id;
    
    // Get session data if available
    const session = getSavedSession(media.sessionId);
    const category = session ? session.category : 'Uncategorized';
    
    // Format the date
    const mediaDate = new Date(media.timestamp);
    const formattedDate = `${mediaDate.toLocaleDateString()} ${mediaDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    
    // Get media name (or use default)
    const mediaName = media.name || `Unnamed ${media.type === 'photo' ? 'Photo' : 'Video'}`;
    
    // Create type icon
    const typeIcon = media.type === 'photo'
      ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`
      : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`;
    
    // Check if we have preview data stored in different formats
    let previewUrl = '';
    let previewContent = '';
    
    // Check for blob or preview format in different properties
    if (media.preview instanceof Blob) {
      // If we have a preview blob (from our enhanced media functionality)
      previewUrl = URL.createObjectURL(media.preview);
      
      if (media.type === 'photo') {
        previewContent = `<img src="${previewUrl}" alt="${mediaName}" class="media-thumbnail">`;
      } else {
        previewContent = `
          <div class="video-thumbnail">
            <img src="${previewUrl}" alt="${mediaName}" class="media-thumbnail">
            <div class="play-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3" fill="white"></polygon>
              </svg>
            </div>
          </div>
        `;
      }
    } else if (media.blob instanceof Blob) {
      // Legacy format - direct blob
      previewUrl = URL.createObjectURL(media.blob);
      
      if (media.type === 'photo') {
        previewContent = `<img src="${previewUrl}" alt="${mediaName}" class="media-thumbnail">`;
      } else {
        previewContent = `
          <div class="video-thumbnail">
            <video src="${previewUrl}" class="media-thumbnail"></video>
            <div class="play-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3" fill="white"></polygon>
              </svg>
            </div>
          </div>
        `;
      }
    } else {
      // No preview available, show placeholder
      previewContent = `
        <div class="media-placeholder-item">
          <div class="media-type-icon">
            ${typeIcon}
          </div>
          <p>${media.type === 'photo' ? 'Photo' : 'Video'}</p>
        </div>
      `;
    }
    
    // Media item HTML
    mediaItem.innerHTML = `
      <div class="media-preview">
        ${previewContent}
      </div>
      <div class="media-info">
        <div class="media-name">${mediaName}</div>
        <div class="media-date">${formattedDate}</div>
        <div class="media-category">${category}</div>
        <div class="media-actions">
          <button class="view-btn">View</button>
          <button class="delete-btn">Delete</button>
        </div>
      </div>
    `;
    
    // Add event listeners
    const viewBtn = mediaItem.querySelector('.view-btn');
    if (viewBtn) {
      viewBtn.addEventListener('click', () => {
        viewMedia(media);
      });
    }
    
    const deleteBtn = mediaItem.querySelector('.delete-btn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Are you sure you want to delete this ${media.type}? This cannot be undone.`)) {
          deleteMedia(media.id);
        }
      });
    }
    
    // Cleanup URL when element is removed
    if (previewUrl) {
      // Create a MutationObserver to watch for when the element is removed from DOM
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.removedNodes.forEach((node) => {
            if (node === mediaItem || node.contains(mediaItem)) {
              URL.revokeObjectURL(previewUrl);
              observer.disconnect();
            }
          });
        });
      });
      
      // Start observing after a short delay to avoid immediate cleanup
      setTimeout(() => {
        if (mediaItem.parentNode) {
          observer.observe(mediaItem.parentNode, { childList: true, subtree: true });
        }
      }, 100);
    }
    
    return mediaItem;
  } catch (error) {
    console.error('Error creating media item:', error);
    return document.createElement('div');
  }
}

// Update the loadMediaGallery function to handle text-only records
function loadMediaGallery() {
  console.log('Loading media gallery...');
  
  if (!db) {
    console.log('Database not initialized yet');
    if (mediaGallery) {
      mediaGallery.innerHTML = '<div class="media-placeholder"><p>Media gallery is initializing...</p></div>';
    }
    return;
  }
  
  // Clear the gallery
  if (mediaGallery) {
    mediaGallery.innerHTML = '';
  }
  
  // Get filters
  const dateFilter = mediaDateFilter ? mediaDateFilter.value : 'all';
  const categoryFilter = mediaCategoryFilter ? mediaCategoryFilter.value : 'all';
  const typeFilter = mediaTypeFilter ? mediaTypeFilter.value : 'all';
  
  // Get all media files
  const transaction = db.transaction(['mediaFiles'], 'readonly');
  const store = transaction.objectStore('mediaFiles');
  
  store.getAll().onsuccess = function(event) {
    const mediaFiles = event.target.result;
    
    if (!mediaFiles || mediaFiles.length === 0) {
      // Show placeholder if no media
      if (mediaGallery) {
        mediaGallery.innerHTML = `
          <div class="media-placeholder">
            <p>No media recordings found. Use the "Record" button on the timer page to capture photos or videos of your practice!</p>
          </div>
        `;
      }
      return;
    }
    
    // Filter media files based on selected filters
    let filteredMedia = mediaFiles;
    
    // Apply date filter
    if (dateFilter !== 'all') {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const weekAgo = today - (7 * 24 * 60 * 60 * 1000);
      const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).getTime();
      const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()).getTime();
      
      filteredMedia = filteredMedia.filter(media => {
        switch(dateFilter) {
          case 'today':
            return media.timestamp >= today;
          case 'week':
            return media.timestamp >= weekAgo;
          case 'month':
            return media.timestamp >= monthAgo;
          case 'year':
            return media.timestamp >= yearAgo;
          default:
            return true;
        }
      });
    }
    
    // Apply category filter
    if (categoryFilter !== 'all') {
      filteredMedia = filteredMedia.filter(media => {
        const session = getSavedSession(media.sessionId);
        return session && session.category === categoryFilter;
      });
    }
    
    // Apply type filter
    if (typeFilter !== 'all') {
      filteredMedia = filteredMedia.filter(media => media.type === typeFilter);
    }
    
    // Sort by date (newest first)
    filteredMedia.sort((a, b) => b.timestamp - a.timestamp);
    
    if (filteredMedia.length === 0) {
      // Show message if no media after filtering
      if (mediaGallery) {
        mediaGallery.innerHTML = `
          <div class="media-placeholder">
            <p>No media recordings found with the selected filters.</p>
          </div>
        `;
      }
      return;
    }
    
    // Add each media item to the gallery
    filteredMedia.forEach(media => {
      const mediaItem = createMediaItem(media);
      if (mediaGallery) {
        mediaGallery.appendChild(mediaItem);
      }
    });
  };
  
  // Update category filter
  updateCategoryFilter();
}

// View media - showing info only since we don't store the actual files
function viewMedia(media) {
  if (!viewMediaModal) return;
  
  try {
    currentMediaId = media.id;
    
    const viewContent = viewMediaModal.querySelector('.view-media-content');
    if (!viewContent) return;
    
    viewContent.innerHTML = '';
    
    // Create a text display of the media info
    viewContent.innerHTML = `
      <div style="background-color: var(--background-light); padding: 30px; text-align: center; color: var(--text-color);">
        <h3>${media.name}</h3>
        <p>File saved to your device as: ${media.fileName || 'Unknown filename'}</p>
        <p>Date: ${new Date(media.timestamp).toLocaleString()}</p>
        <p>Type: ${media.type === 'photo' ? 'Photo' : 'Video'}</p>
        <p>Please check your device gallery or files to view the actual media content.</p>
      </div>
    `;
    
    viewMediaModal.style.display = 'flex';
  } catch (error) {
    console.error('Error displaying media info:', error);
    notify('Error displaying media information. Please try again.', 'error');
  }
}

// Simple direct camera implementation
document.addEventListener('DOMContentLoaded', function() {
  const cameraButton = document.getElementById('camera-button');
  const addNoteButton = document.getElementById('add-note-button');
  const noteModal = document.getElementById('note-modal');
  const noteType = document.getElementById('note-type');
  const noteContent = document.getElementById('note-content');
  const saveNoteBtn = document.getElementById('save-note');
  const closeNoteBtn = document.getElementById('close-note');
  const mediaGallery = document.getElementById('media-gallery');
  
  // Media variables
  let mediaRecords = [];
  let currentMedia = null;
  
  // Load saved records from localStorage
  try {
    const storedRecords = localStorage.getItem('mediaRecords');
    if (storedRecords) {
      mediaRecords = JSON.parse(storedRecords);
      refreshMediaGallery();
    }
  } catch (error) {
    console.error('Error loading media records:', error);
  }
  
  // Add Note button functionality
  if (addNoteButton) {
    addNoteButton.addEventListener('click', function() {
      // Reset form fields
      if (noteType) noteType.value = 'lesson';
      if (noteContent) noteContent.value = '';
      
      // Show the modal
      if (noteModal) noteModal.style.display = 'block';
    });
  }
  
  // Close note modal
  if (closeNoteBtn && noteModal) {
    closeNoteBtn.addEventListener('click', () => {
      noteModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    noteModal.addEventListener('click', (e) => {
      if (e.target === noteModal) {
        noteModal.style.display = 'none';
      }
    });
  }
  
  // Save note button
  if (saveNoteBtn) {
    saveNoteBtn.addEventListener('click', function() {
      // Get note content and type
      const content = noteContent.value.trim();
      const type = noteType.value;
      
      if (!content) {
        notify('Please enter note content', 'error');
        return;
      }
      
      // Create record object
      const record = {
        id: Date.now().toString(),
        type: 'note',
        noteType: type,
        name: `${type.charAt(0).toUpperCase() + type.slice(1)} Note - ${new Date().toLocaleDateString()}`,
        content: content,
        timestamp: new Date().toISOString(),
        fileName: null
      };
      
      // Add to records array
      mediaRecords.push(record);
      
      // Save to localStorage
      localStorage.setItem('mediaRecords', JSON.stringify(mediaRecords));
      
      // Refresh the gallery
      refreshMediaGallery();
      
      // Close the modal
      noteModal.style.display = 'none';
      
      // Notify user
      notify('Note saved successfully', 'success');
    });
  }

  // Camera button functionality
  if (cameraButton) {
    cameraButton.addEventListener('click', function() {
      // Create options menu for camera
      showCameraOptions();
    });
  }
  
  // Show camera options menu (Photo or Video)
  function showCameraOptions() {
    // Create an overlay for the camera options
    const optionsOverlay = document.createElement('div');
    optionsOverlay.className = 'media-type-menu';
    optionsOverlay.style.position = 'fixed';
    optionsOverlay.style.top = '0';
    optionsOverlay.style.left = '0';
    optionsOverlay.style.width = '100%';
    optionsOverlay.style.height = '100%';
    optionsOverlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    optionsOverlay.style.display = 'flex';
    optionsOverlay.style.flexDirection = 'column';
    optionsOverlay.style.justifyContent = 'center';
    optionsOverlay.style.alignItems = 'center';
    optionsOverlay.style.zIndex = '1000';
    
    // Add options buttons
    optionsOverlay.innerHTML = `
      <div style="background-color: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px;">
        <h3 style="text-align: center; margin-top: 0;">Choose Media Type</h3>
        <button id="take-photo-option" style="display: block; width: 100%; padding: 15px; margin: 10px 0; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; font-size: 16px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Take Photo
        </button>
        <button id="record-video-option" style="display: block; width: 100%; padding: 15px; margin: 10px 0; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; font-size: 16px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <polygon points="23 7 16 12 23 17 23 7"/>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
          </svg>
          Record Video
        </button>
        <button id="cancel-media-option" style="display: block; width: 100%; padding: 15px; margin: 10px 0; background-color: #f5f5f5; color: #333; border: none; border-radius: 5px; font-size: 16px;">
          Cancel
        </button>
      </div>
    `;
    
    document.body.appendChild(optionsOverlay);
    
    // Add event listeners to the option buttons
    document.getElementById('take-photo-option').addEventListener('click', function() {
      document.body.removeChild(optionsOverlay);
      captureMedia('photo');
    });
    
    document.getElementById('record-video-option').addEventListener('click', function() {
      document.body.removeChild(optionsOverlay);
      captureMedia('video');
    });
    
    document.getElementById('cancel-media-option').addEventListener('click', function() {
      document.body.removeChild(optionsOverlay);
    });
  }
  
  // Capture media (photo or video)
  function captureMedia(mediaType) {
    // Create file input for camera capture
    const input = document.createElement('input');
    input.type = 'file';
    
    if (mediaType === 'photo') {
      input.accept = 'image/*';
      input.capture = 'environment'; // Use back camera
    } else {
      input.accept = 'video/*';
      input.capture = true;
    }
    
    input.onchange = function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const type = file.type.startsWith('image/') ? 'photo' : 'video';
        
        // Store the file temporarily
        currentMedia = {
          file: file,
          type: type
        };
        
        // Prompt for name after capturing
        promptForMediaName(type);
      }
    };
    
    input.click();
  }
  
  // Prompt for media name
  function promptForMediaName(mediaType) {
    const defaultName = getDefaultName(mediaType);
    
    // Create an overlay for the name prompt
    const nameOverlay = document.createElement('div');
    nameOverlay.style.position = 'fixed';
    nameOverlay.style.top = '0';
    nameOverlay.style.left = '0';
    nameOverlay.style.width = '100%';
    nameOverlay.style.height = '100%';
    nameOverlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    nameOverlay.style.display = 'flex';
    nameOverlay.style.flexDirection = 'column';
    nameOverlay.style.justifyContent = 'center';
    nameOverlay.style.alignItems = 'center';
    nameOverlay.style.zIndex = '1001';
    
    // Add name input form
    nameOverlay.innerHTML = `
      <div style="background-color: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px;">
        <h3 style="text-align: center; margin-top: 0;">Name Your ${mediaType === 'photo' ? 'Photo' : 'Video'}</h3>
        <input type="text" id="capture-name-input" placeholder="Enter a name..." value="${defaultName}" 
               style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
        <div style="display: flex; justify-content: space-between;">
          <button id="save-capture" style="padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; font-size: 16px; flex: 1; margin-right: 5px;">
            Save
          </button>
          <button id="cancel-capture" style="padding: 10px 15px; background-color: #f5f5f5; color: #333; border: none; border-radius: 5px; font-size: 16px; flex: 1; margin-left: 5px;">
            Cancel
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(nameOverlay);
    
    // Focus the input field
    setTimeout(() => {
      const nameInput = document.getElementById('capture-name-input');
      if (nameInput) {
        nameInput.focus();
        nameInput.select(); // Select the default text
      }
    }, 100);
    
    // Add event listeners
    document.getElementById('save-capture').addEventListener('click', function() {
      const mediaName = document.getElementById('capture-name-input').value.trim() || defaultName;
      saveCapture(mediaName);
      document.body.removeChild(nameOverlay);
    });
    
    document.getElementById('capture-name-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const mediaName = document.getElementById('capture-name-input').value.trim() || defaultName;
        saveCapture(mediaName);
        document.body.removeChild(nameOverlay);
      }
    });
    
    document.getElementById('cancel-capture').addEventListener('click', function() {
      document.body.removeChild(nameOverlay);
      currentMedia = null;
    });
  }
  
  // Save captured media
  function saveCapture(mediaName) {
    if (!currentMedia) {
      notify('Error: No media to save', 'error');
      return;
    }
    
    const file = currentMedia.file;
    const type = currentMedia.type;
    
    // Create file extension based on media type
    const fileExtension = type === 'photo' ? '.jpg' : '.mp4';
    const safeFileName = mediaName.replace(/[^a-z0-9]/gi, '_') + fileExtension;
    
    // Create a downloadable URL from the file
    const blobUrl = URL.createObjectURL(file);
    
    // Create and trigger download
    const downloadLink = document.createElement('a');
    downloadLink.href = blobUrl;
    downloadLink.download = safeFileName;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    // Create media record
    const mediaRecord = {
      id: 'media_' + Date.now(),
      name: mediaName,
      timestamp: Date.now(),
      type: type,
      fileName: safeFileName
    };
    
    // Save media record
    saveMediaRecord(mediaRecord);
    
    // Reset current media
    currentMedia = null;
    
    // Show success message
    notify(`${type === 'photo' ? 'Photo' : 'Video'} saved as "${safeFileName}"`, 'success');
    
    // Check for iOS and show additional instructions if needed
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      setTimeout(() => {
        notify('On iOS: Tap and hold on the opened media, then select "Save to Photos"', 'info', 8000);
      }, 1000);
    }
    
    // Clean up blob URL
    setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
  }
  
  // Save media record to localStorage and update UI
  function saveMediaRecord(record) {
    // Add to records array
    mediaRecords.push(record);
    
    // Save to localStorage
    localStorage.setItem('mediaRecords', JSON.stringify(mediaRecords));
    
    // Update the UI
    refreshMediaGallery();
  }
  
  // Refresh media gallery display
  function refreshMediaGallery() {
    if (!mediaGallery) return;
    
    // Sort records by timestamp (newest first)
    const sortedRecords = [...mediaRecords].sort((a, b) => b.timestamp - a.timestamp);
    
    // Clear current gallery
    mediaGallery.innerHTML = '';
    
    if (sortedRecords.length === 0) {
      const placeholder = document.createElement('div');
      placeholder.className = 'media-placeholder';
      placeholder.innerHTML = '<p>No media recordings yet. Use the "Record" button to capture photos or videos.</p>';
      mediaGallery.appendChild(placeholder);
      return;
    }
    
    // Add each record to the gallery
    sortedRecords.forEach(record => {
      const mediaItem = createMediaElement(record);
      mediaGallery.appendChild(mediaItem);
    });
  }
  
  // Create media element for display
  function createMediaElement(mediaRecord) {
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.setAttribute('data-id', mediaRecord.id);
    mediaItem.setAttribute('data-type', mediaRecord.type || 'note');
    
    // Format the date
    const date = new Date(mediaRecord.timestamp);
    const formattedShortDate = `${date.toLocaleDateString()}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    
    // Set the icon based on media type
    let icon = '';
    if (mediaRecord.type === 'photo') icon = '📷 ';
    if (mediaRecord.type === 'video') icon = '🎥 ';
    if (mediaRecord.type === 'note') icon = '📝 ';
    
    // Set the content with improved styling
    let contentHtml = `
      <div style="padding: 15px; background-color: #f8f8f8; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">
            ${icon} ${mediaRecord.name}
          </div>
          <div style="font-size: 12px; color: #666; text-align: right;">
            ${formattedShortDate}
          </div>
        </div>`;
        
    // Add note content preview if it's a note
    if (mediaRecord.type === 'note' && mediaRecord.content) {
      const noteBackground = mediaRecord.noteType === 'lesson' ? '#e8f5e9' : '#fff3e0';
      const noteBorder = mediaRecord.noteType === 'lesson' ? '#4caf50' : '#ff9800';
      const noteTypeLabel = mediaRecord.noteType === 'lesson' ? 'Lesson Note' : 'Practice Note';
      
      contentHtml += `
        <div style="margin-top: 10px; padding: 10px; background-color: ${noteBackground}; border-left: 3px solid ${noteBorder}; border-radius: 4px; text-align: left;">
          <div style="display: inline-block; font-size: 12px; font-weight: bold; padding: 2px 6px; background-color: ${noteBorder}; color: white; border-radius: 3px; margin-bottom: 5px;">
            ${noteTypeLabel}
          </div>
          <div style="white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; margin-top: 5px; max-height: 80px;">
            ${mediaRecord.content.substring(0, 100)}${mediaRecord.content.length > 100 ? '...' : ''}
          </div>
        </div>`;
    } else {
      contentHtml += `
        <div style="margin-top: 5px; font-size: 13px; color: #555;">
          ${mediaRecord.fileName ? `Saved as: ${mediaRecord.fileName}` : 'Text record only'}
        </div>`;
    }
    
    contentHtml += `
        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
          <button class="copy-name-btn" style="padding: 8px 12px; background: #e3f2fd; color: #1565c0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
            Copy Name
          </button>
          <button class="delete-media-btn" style="padding: 8px 12px; background: #ffebee; color: #e53935; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
            Delete
          </button>
        </div>
      </div>
    `;
    
    mediaItem.innerHTML = contentHtml;
    
    // Add event listeners
    mediaItem.querySelector('.copy-name-btn').addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent item click
      
      navigator.clipboard.writeText(mediaRecord.name)
        .then(() => notify('Name copied to clipboard', 'success'))
        .catch(() => notify('Failed to copy to clipboard', 'error'));
    });
    
    mediaItem.querySelector('.delete-media-btn').addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent item click
      
      if (confirm('Delete this media record?')) {
        // Remove from array
        mediaRecords = mediaRecords.filter(record => record.id !== mediaRecord.id);
        
        // Save to localStorage
        localStorage.setItem('mediaRecords', JSON.stringify(mediaRecords));
        
        // Update UI
        refreshMediaGallery();
        
        notify('Media record deleted', 'success');
      }
    });
    
    // Add click listener to view note or media
    mediaItem.addEventListener('click', function() {
      if (mediaRecord.type === 'note') {
        // Create a modal to view the full note
        const noteViewModal = document.createElement('div');
        noteViewModal.className = 'modal';
        noteViewModal.style.display = 'block';
        noteViewModal.style.position = 'fixed';
        noteViewModal.style.zIndex = '9999';
        noteViewModal.style.left = '0';
        noteViewModal.style.top = '0';
        noteViewModal.style.width = '100%';
        noteViewModal.style.height = '100%';
        noteViewModal.style.overflow = 'auto';
        noteViewModal.style.backgroundColor = 'rgba(0,0,0,0.4)';
        
        const noteBackground = mediaRecord.noteType === 'lesson' ? '#e8f5e9' : '#fff3e0';
        const noteBorder = mediaRecord.noteType === 'lesson' ? '#4caf50' : '#ff9800';
        const noteTypeLabel = mediaRecord.noteType === 'lesson' ? 'Lesson Note' : 'Practice Note';
        
        noteViewModal.innerHTML = `
          <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h2 style="margin: 0;">${icon} ${mediaRecord.name}</h2>
              <button class="close-note-view" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
              <div style="display: inline-block; font-size: 14px; font-weight: bold; padding: 4px 8px; background-color: ${noteBorder}; color: white; border-radius: 4px;">
                ${noteTypeLabel}
              </div>
              <div style="font-size: 14px; color: #666;">
                ${formattedShortDate}
              </div>
            </div>
            
            <div style="padding: 15px; background-color: ${noteBackground}; border-radius: 4px; margin-bottom: 20px; white-space: pre-wrap; text-align: left;">
              ${mediaRecord.content}
            </div>
            
            <div style="display: flex; justify-content: center;">
              <button class="close-note-view-btn" style="padding: 10px 20px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Close
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(noteViewModal);
        
        // Add event listeners to close the modal
        noteViewModal.querySelector('.close-note-view').addEventListener('click', function() {
          document.body.removeChild(noteViewModal);
        });
        
        noteViewModal.querySelector('.close-note-view-btn').addEventListener('click', function() {
          document.body.removeChild(noteViewModal);
        });
        
        noteViewModal.addEventListener('click', function(e) {
          if (e.target === noteViewModal) {
            document.body.removeChild(noteViewModal);
          }
        });
      }
      // You could add other media type handling here if needed
    });
    
    return mediaItem;
  }
  
  // Set up media filters
  const mediaDateFilter = document.getElementById('media-date-filter');
  const mediaCategoryFilter = document.getElementById('media-category-filter');
  const mediaTypeFilter = document.getElementById('media-type-filter');
  
  // Apply filters to media gallery
  function applyMediaFilters() {
    const dateFilter = mediaDateFilter ? mediaDateFilter.value : 'all';
    const categoryFilter = mediaCategoryFilter ? mediaCategoryFilter.value : 'all';
    const typeFilter = mediaTypeFilter ? mediaTypeFilter.value : 'all';
    
    // Get all media items
    const mediaItems = document.querySelectorAll('.media-item');
    let visibleCount = 0;
    
    mediaItems.forEach(item => {
      const mediaId = item.getAttribute('data-id');
      const mediaType = item.getAttribute('data-type') || 'note';
      
      // Find the media record
      const mediaRecord = mediaRecords.find(record => record.id === mediaId);
      if (!mediaRecord) return;
      
      let isVisible = true;
      
      // Apply date filter
      if (dateFilter !== 'all') {
        const recordDate = new Date(mediaRecord.timestamp);
        const now = new Date();
        
        if (dateFilter === 'today') {
          isVisible = isVisible && (
            recordDate.getDate() === now.getDate() &&
            recordDate.getMonth() === now.getMonth() &&
            recordDate.getFullYear() === now.getFullYear()
          );
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now);
          weekAgo.setDate(now.getDate() - 7);
          isVisible = isVisible && recordDate >= weekAgo;
        } else if (dateFilter === 'month') {
          const monthAgo = new Date(now);
          monthAgo.setMonth(now.getMonth() - 1);
          isVisible = isVisible && recordDate >= monthAgo;
        } else if (dateFilter === 'year') {
          const yearAgo = new Date(now);
          yearAgo.setFullYear(now.getFullYear() - 1);
          isVisible = isVisible && recordDate >= yearAgo;
        }
      }
      
      // Apply category filter
      if (categoryFilter !== 'all' && mediaRecord.category) {
        isVisible = isVisible && mediaRecord.category === categoryFilter;
      }
      
      // Apply type filter
      if (typeFilter !== 'all') {
        isVisible = isVisible && mediaRecord.type === typeFilter;
      }
      
      // Show/hide the item
      item.style.display = isVisible ? 'block' : 'none';
      
      if (isVisible) {
        visibleCount++;
      }
    });
    
    // Show placeholder if no items visible
    const placeholder = document.querySelector('.media-placeholder');
    if (placeholder) {
      placeholder.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }
  
  // Set up filter event listeners
  if (mediaDateFilter) {
    mediaDateFilter.addEventListener('change', applyMediaFilters);
  }
  
  if (mediaTypeFilter) {
    mediaTypeFilter.addEventListener('change', applyMediaFilters);
  }
  
  // Generate default name for media
  function getDefaultName(type) {
    const now = new Date();
    const datePart = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
    const timePart = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    if (type === 'photo') {
      return `Photo ${datePart} ${timePart}`;
    } else if (type === 'video') {
      return `Video ${datePart} ${timePart}`;
    } else {
      return `Recording ${datePart} ${timePart}`;
    }
  }
});

// Manual Session Functions
function showManualSessionForm() {
  const manualSessionForm = document.getElementById('manual-session-form');
  const addManualSessionBtn = document.getElementById('add-manual-session');
  
  if (manualSessionForm && addManualSessionBtn) {
    manualSessionForm.style.display = 'block';
    addManualSessionBtn.style.display = 'none';
    
    // Reset the form
    const today = new Date().toISOString().split('T')[0];
    manualSessionForm.querySelector('input[name="manual-session-date"]').value = today;
    manualSessionForm.querySelector('input[name="manual-session-hours"]').value = '';
    manualSessionForm.querySelector('input[name="manual-session-minutes"]').value = '';
    manualSessionForm.querySelector('select[name="manual-session-category"]').value = '';
    manualSessionForm.querySelector('textarea[name="manual-session-notes"]').value = '';
  }
}

// ... rest of existing code ...
  </script>
  
  <!-- Add Note Modal -->
  <div id="note-modal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
      <h2>Add New Note</h2>
      
      <div class="form-group">
        <label for="note-type">Note Type</label>
        <select id="note-type" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 15px;">
          <option value="lesson">Lesson</option>
          <option value="practice">Practice</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="note-content">Note Content</label>
        <textarea id="note-content" style="width: 100%; height: 200px; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical; font-family: inherit;"></textarea>
      </div>
      
      <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
        <button id="save-note" class="save-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Note
        </button>
        <button id="close-note" class="cancel-btn" style="background-color: #757575;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancel
        </button>
      </div>
    </div>
  </div>
</body>
</html>
